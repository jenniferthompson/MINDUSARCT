---
title: "Primary In-Hospital Outcomes Analysis of the MIND-USA Clinical Trial"
output:
  html_notebook:
    theme: flatly
    highlight: tango
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
---

The MIND-USA clinical trial aims to define the role of antipsychotics in the management of delirium in critically ill patients, specifically comparing haloperidol (typical antipsychotic) and ziprasidone (atypical antipsychotic) to placebo. Further details can be found in the trial listing on [clinicaltrials.gov](https://clinicaltrials.gov/ct2/show/NCT01211522).

```{r setup}
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(purrr))
suppressPackageStartupMessages(library(stringr))
suppressPackageStartupMessages(library(kableExtra))
suppressPackageStartupMessages(library(captioner))

## Helper functions
format_comma <- partial(format, big.mark = ",")
sum_na <- partial(sum, na.rm = TRUE)
q25 <- partial(quantile, probs = 0.25, na.rm = TRUE)
q50 <- partial(quantile, probs = 0.50, na.rm = TRUE)
q75 <- partial(quantile, probs = 0.75, na.rm = TRUE)
mean_na <- partial(mean, na.rm = TRUE)
sd_na <- partial(sd, na.rm = TRUE)
rndformat <- function(x, digits = 2){ format(round(x, digits), nsmall = digits) }
get_npct <- function(num, denom){
  sprintf("%s (%s%%)", num, round((num / denom) * 100))
}
describe_cont <- function(
  v_q50, v_q25, v_q75, v_mean, v_sd, dig_iqr = 0, dig_msd = 2
){
  sprintf(
    "%s [%s, %s]\\\n%s +/- %s",
    rndformat(v_q50, digits = dig_iqr),
    rndformat(v_q25, digits = dig_iqr),
    rndformat(v_q75, digits = dig_iqr),
    rndformat(v_mean, digits = dig_msd),
    rndformat(v_sd, digits = dig_msd)
  )
}

## kable_styling wrapper to ensure all tables are consistently styled
mykablestyle <- function(obj, stripes = FALSE, ...){
  boptions <- c("hover", "responsive", "condensed", "bordered")
  if(stripes){ boptions <- c(boptions, "striped") }
  
  kable_styling(
    obj,
    bootstrap_options = boptions,
    full_width = FALSE,
    ...
  )
}

## Analysis datasets are stored in an .Rdata file, originally created and stored
##  by create_rctdata.R in ../MINDUSADataMgmt
load("analysisdata/rct.Rdata")

```

```{r captions, results = "hide"}
## -- Table and figure captions ------------------------------------------------
table_nums <- captioner(prefix = "Table")
fig_nums <- captioner(prefix = "Figure")

table_nums(
  name = "screening", caption = "Overview of Screening, Exclusions & Randomization"
)
table_nums(name = "exclusions", caption = "Study Exclusions")
table_nums(
  name = "intervention_pt", caption = "Description of Intervention by Patient"
)
table_nums(
  name = "intervention_dose",
  caption = "Description of Intervention by Study Drug Dose"
)

```

# Screening, Consent, and Randomization

Because this trial aims to describe the association between antipsychotics and treatment of delirium (rather than prevention), patients were required to be delirious prior to being randomized to study drug. In order to treat delirium immediately upon it being observed, however, patients (or their surrogates) were consented as soon as they met study inclusion criteria and were found not to meet exclusion criteria.

Upon consent, patients could be randomized any time in the following five days, provided no exclusions were met within that time, the patient remained in the ICU, and they did eventually become delirious. Patients are considered "disqualified" if they left the ICU or the study (via discharge, death, or withdrawal) prior to experiencing delirium, or never experienced delirium in the five days following consent.

```{r prep_screen_table}
## -- Create a data frame with rows = various categories of patients -----------
## --  (screened, consented, etc), along with N, % of patients in each ---------

## Get total N in each category; result = df with 1 row, columns = categories
## This will be added to a "vertical" data.frame to use as denominators
screen_ns <- ptstatus_df %>%
  ## Only include patients who met screening criteria
  filter(screened) %>%
  ## Create indicators for each reason for disqualification; patients
  ## disqualified for meeting exclusion criteria are included in "excluded after
  ## consent" and will not be listed here
  mutate(
    dq_nodel = ifelse(!disqualified, NA, dq_reason == "No delirium within 5 days"),
    dq_icudc = ifelse(!disqualified, NA, dq_reason == "ICU discharge before delirium"),
    dq_diedwd = ifelse(!disqualified, NA, dq_reason == "Died/withdrew before delirium")
  ) %>%
  ## Select the categories we want
  select(screened, excluded_imm, approached, refused, consented, excluded_later,
         disqualified, randomized, dq_nodel, dq_icudc, dq_diedwd,
         matches("^rand\\_")) %>%
  summarize_all(sum, na.rm = TRUE)

## Create data.frame for final table, starting with horizontal df
screen_table <- screen_ns %>%
  ## Transpose to one row per category
  gather(key = "status", value = "npts") %>%
  ## Add potential denominators from horizontal df (need to replicate original
  ##  to get the same number of rows)
  bind_cols(bind_rows(rep(list(screen_ns), nrow(.)))) %>%
  mutate(
    ## Determine appropriate denominator for each category %
    denom = ifelse(status %in% c("excluded_imm", "approached"), screened,
            ifelse(status %in% c("refused", "consented"), approached,
            ifelse(status %in% c("excluded_later", "randomized", "disqualified"),
                   consented,
            ifelse(substr(status, 1, 4) == "rand", randomized,
            ifelse(substr(status, 1, 2) == "dq", disqualified, NA))))),
    ## Calculate %
    pctpts = round((npts / denom) * 100),
    ## More informative statuses
    status_label = case_when(
      status == "screened"       ~ "Screened within 72 hours of meeting inclusion criteria",
      status == "excluded_imm"   ~ "Excluded immediately (details below)",
      status == "approached"     ~ "Staff approached patient/surrogate",
      status == "refused"        ~ "Patient/surrogate refused consent",
      status == "consented"      ~ "Consented for study",
      status == "excluded_later" ~ "Excluded after consent (details below)",
      status == "disqualified"   ~ "Disqualified prior to randomization",
      status == "randomized"     ~ "Randomized to study drug",
      status == "rand_mv"        ~ "Mechanical ventilation",
      status == "rand_nippv"     ~ "Non-invasive positive pressure ventilation (NIPPV)",
      status == "rand_shock"     ~ "Requiring treatment for shock",
      status == "dq_nodel"       ~ "No delirium in 5 days after consent",
      status == "dq_icudc"       ~ "ICU discharge prior to delirium",
      status == "dq_diedwd"      ~ "Died/withdrew prior to delirium",
      TRUE ~ status
    ),
    ## Create character string with N (%)
    npct = ifelse(is.na(pctpts), format_comma(npts),
                  sprintf("%s (%s%%)", format_comma(npts), pctpts))
  ) %>%
  select(status_label, npct)

## When did screening take place? Find first and last month
screening_months <- ptstatus_df %>%
  select(screened, exc_month, exc_year, enroll_month, enroll_year) %>%
  mutate(screen_month = ifelse(!is.na(exc_month), exc_month, enroll_month),
         screen_year = ifelse(!is.na(exc_year), exc_year, enroll_year)) %>%
  filter(screened & !is.na(screen_month)) %>%
  arrange(screen_year, screen_month) %>%
  slice(c(1, n())) %>%
  mutate(monthyr = paste(month.name[screen_month], screen_year))

first_month <- screening_months %>% slice(1) %>% pull(monthyr)
last_month <- screening_months %>% slice(n()) %>% pull(monthyr)

```

`r table_nums("screening", display = "cite")` presents patient flow information for the `r format_comma(sum_na(ptstatus_df$screened))` patients who were screened with 72 hours of meeting inclusion criteria. Screening took place between `r first_month` and `r last_month`.

### `r table_nums("screening")`

```{r print_screen_table}
screen_table %>%
  kable(format = "html", col.names = c("", "N (%)"), align = c("l", "r")) %>%
  mykablestyle %>%
  group_rows("Screened Patients", 2, 3) %>%
  group_rows("Approached Patients", 4, 5) %>%
  group_rows("Consented Patients", 6, 8) %>%
  group_rows("Reasons for Disqualification", 9, 11) %>%
  group_rows("Organ Failures Present at Randomization", 12, 14) %>%
  row_spec(grep("^Randomized", screen_table$status_label), bold = TRUE)

```

Patients could have none, one, or two of the listed organ failures present at randomization; it is not necessarily expected that percentages add up to 100%.

### `r table_nums("exclusions")`

```{r prep_exclusions}
## Some exclusions aren't relevant for our purposes here:
## - Rapidly resolving organ failure, 72h eligibility period exceeded:
##     indicates patient did not meet screening criteria
## - Patient/surrogate refusal: not considered a study exclusion
## We're also interested in the *combined* version of some:
## - pregnancy + breast feeding (2a, 2b); look at exc_2 instead
## - all exclusions relating to time running out (9c, e, f); look at exc_9cef
exclusion_rsns <- paste0(
  "exc_",
  c("2_pregbf", "34_neuro", "5_torsadesqtc", "6_maintmeds", "7_nmsallergy",
    "8_death24", "9a_refusal_md", "9cef_time", "10_blind_lang", "11_prison",
    "12_coenroll", "13_iqcode", "14_screen", "99_other")
)

exc_table <- ptstatus_df %>%
  ## Select only exclusion indicators (overall + specific exclusions)
  select(id, matches("^excluded\\_"), one_of(exclusion_rsns)) %>%
  
  ## Reshape to long format: one row per "time" of exclusion (ever, screening,
  ##  after consent)
  gather(key = "when", value = "excluded", excluded_imm:excluded_ever) %>%
  
  ## Count only patients who were actually excluded
  filter(excluded) %>%
  
  ## Get count of each exclusion by time point
  group_by(when) %>%
  summarise_at(vars(-id), sum_na) %>%
  ungroup %>%
  
  ## Reshape to long format: one row per time + exclusion
  gather(key = "exclusion", value = "nexc", matches("^exc\\_[0-9]+")) %>%
  
  mutate(
    ## Calculate % of exclusions at each time point for each possible exclusion
    pctexc = round((nexc / excluded) * 100),
    ## Formatting/text work
    npct = sprintf("%s (%s%%)", format_comma(nexc), pctexc),
    when = gsub("^excluded\\_", "", when),
    exclusion = case_when(
      exclusion == "exc_2_pregbf"      ~ "Pregnancy or breast feeding",
      exclusion == "exc_34_neuro"      ~ "Severe dementia or neurodegenerative disease",
      exclusion == "exc_5_torsadesqtc" ~ "History of Torsades or prolonged QTc",
      exclusion == "exc_6_maintmeds"   ~ "Maintenance therapy with antipsychotics/lithium",
      exclusion == "exc_7_nmsallergy"  ~ "History of NMS or allergy to study drugs",
      exclusion == "exc_8_death24"     ~ "Expected death within 24 hours",
      exclusion == "exc_9a_refusal_md" ~ "Attending physician refusal",
      exclusion == "exc_9cef_time"     ~ "No surrogate available within window",
      exclusion == "exc_10_blind_lang" ~ "Blind, deaf, or unable to speak English",
      exclusion == "exc_11_prison"     ~ "Incarceration",
      exclusion == "exc_12_coenroll"   ~ "Enrolled in a study ineligible for co-enrollment",
      exclusion == "exc_13_iqcode"     ~ "IQCODE score >= 4.5",
      exclusion == "exc_14_screen"     ~ "Screening failure",
      TRUE ~ "Other exclusion"
    )
  ) %>%
  select(exclusion, when, npct) %>%
  spread(key = when, value = npct) %>%
  arrange(desc(as.numeric(gsub(",", "", gsub(" \\([0-9]+\\%\\)$", "", ever)))))

exc_colheads <- c(
  "Exclusion",
  sprintf("Ever\\\n(N = %s)", format_comma(sum_na(ptstatus_df$excluded_ever))),
  sprintf("At Screening\\\n(N = %s)", format_comma(sum_na(ptstatus_df$excluded_imm))),
  sprintf("After Consent\\\n(N = %s)", format_comma(sum_na(ptstatus_df$excluded_later)))
)

```

Exclusions could take place at the time of screening (vast majority), or after consent, if a patient was determined to have cognitive disability (indicated by an IQCODE score >= 4.5) or was discovered to have an exclusion criteria prior to randomization. For the `r format_comma(sum_na(ptstatus_df$excluded_ever))` patients excluded from MINDUSA, `r table_nums("exclusions", display = "cite")` presents exclusions:

1. At any point (column 1; % out of all exclusions)
1. At the time of screening (column 2; % out of all screening exclusions)
1. After consent (column 3; % out of all post-consent exclusions)

Patients could meet multiple exclusion criteria; therefore, column percentages may total more than 100%.

```{r print_exc_table}
exc_table %>%
  kable(format = "html", col.names = exc_colheads, align = c("l", rep("r", 3))) %>%
  mykablestyle(stripes = TRUE)

```

# Description of the Intervention

Once randomized, patients could receive study drug for treatment of delirium for up to 14 days, up to twice per day (with a third dose occasionally permitted in rare cases). Study drug could be held temporarily, either for delirium resolution or for other reasons, or permanently discontinued. `r table_nums("intervention_pt", display = "cite")` describes randomization, receipt of study drug, reasons for study drug hold or discontinuation, and status at the end of hospitalization for each of the three treatment groups. `r table_nums("intervention_dose", display = "cite")` describes all opportunities to receive study drug dose.

In both tables, quantities are represented as either `N (%)` or as `median [25th, 75th percentiles]`, followed by `mean +/- standard deviation`.

**Note** that temporary holds and permanent discontinuations listed below only include drug stopped for adverse clinical reasons; they do *not* include instances where study drug was not administered due to resolution of delirium or patient unavailability (including ICU discharge, death, study withdrawal, being off the floor, or being placed on comfort care measures/hospice).

## Intervention by Patient

[PLACEHOLDER TEXT TILL WE GET REAL TREATMENT GROUPS, ASSUMING TREATMENT MEANS NOTHING] Patients were approximately equally randomized to the three treatment groups, with each group receiving study drug approximately the same number of days and times. Rates of temporary hold and permanent discontinuation were equivalent among all treatment groups.

Among patients with study drug temporarily held, the most common reasons were oversedation and "other." Study drug was most often discontinued by request of the patient, family, or medical team.

### `r table_nums("intervention_pt")`

```{r prep_rand_table}
rand_df <- ptstatus_df %>%
  filter(randomized) %>%
  select(id, randomized, died_inhosp, wd_inhosp, elig_fu) %>%
  ## Add study drug info
  left_join(ptdrug_df, by = "id") %>%
  group_by(trt)

## For later: Vector of IDs of all randomized patients
rand_pts <- ptstatus_df %>% filter(randomized) %>% pull(id)

## Summarize variables that just need sums
rand_sums <- rand_df %>%
  summarise_at(
    vars(randomized, ever_studydrug, ever_drug_held,
         matches("^ever\\_held\\_[a-z]+$"),
         ever_drug_permdc, matches("^permdc\\_[a-z]+$"),
         died_inhosp, wd_inhosp, elig_fu),
    funs(sum_na)
  )

## Summarize continuous variables
rand_cont <- rand_df %>%
  summarise_at(
    vars(num_drug_days, num_drug_doses),
    funs(q25, q50, q75, "mean" = mean_na, "sd" = sd_na)
  )

## Recombine
rand_table <- left_join(rand_sums, rand_cont, by = "trt") %>%
  ## Calculate and create strings for table
  mutate(
    npct_studydrug = get_npct(ever_studydrug, randomized),
    npct_held = get_npct(ever_drug_held, ever_studydrug),
    npct_held_ae = get_npct(ever_held_ae, ever_drug_held),
    npct_held_dystonia = get_npct(ever_held_dystonia, ever_drug_held),
    npct_held_eps = get_npct(ever_held_eps, ever_drug_held),
    npct_held_other = get_npct(ever_held_other, ever_drug_held),
    npct_held_oversed = get_npct(ever_held_oversed, ever_drug_held),
    npct_held_refuseptfam = get_npct(ever_held_refuseptfam, ever_drug_held),
    npct_held_qtc = get_npct(ever_held_qtc, ever_drug_held),
    npct_held_refuseteam = get_npct(ever_held_refuseteam, ever_drug_held),
    npct_permdc = get_npct(ever_drug_permdc, ever_studydrug),
    npct_permdc_ae = get_npct(permdc_ae, ever_drug_permdc),
    npct_permdc_coma = get_npct(permdc_coma, ever_drug_permdc),
    npct_permdc_refuseteam = get_npct(permdc_refuseteam, ever_drug_permdc),
    npct_permdc_nms = get_npct(permdc_nms, ever_drug_permdc),
    npct_permdc_react = get_npct(permdc_react, ever_drug_permdc),
    npct_permdc_other = get_npct(permdc_other, ever_drug_permdc),
    npct_permdc_refuseptfam = get_npct(permdc_refuseptfam, ever_drug_permdc),
    npct_permdc_torsades = get_npct(permdc_torsades, ever_drug_permdc),
    npct_died = get_npct(died_inhosp, randomized),
    npct_wd = get_npct(wd_inhosp, randomized),
    npct_elig = get_npct(elig_fu, randomized),

    drug_days = describe_cont(
      num_drug_days_q50, num_drug_days_q25, num_drug_days_q75,
      num_drug_days_mean, num_drug_days_sd
    ),
    drug_doses = describe_cont(
      num_drug_doses_q50, num_drug_doses_q25, num_drug_doses_q75,
      num_drug_doses_mean, num_drug_doses_sd
    )
  ) %>%
  select(trt, randomized, npct_studydrug, drug_days, drug_doses, npct_held,
         matches("^npct\\_held\\_"), npct_permdc, matches("^npct\\_permdc\\_"),
         npct_died, npct_wd, npct_elig) %>%
  gather(key = table_row, value = table_string, -trt) %>%
  spread(key = trt, value = table_string) %>%
  mutate(
    sort_order = case_when(
      table_row == "randomized" ~ 1,
      table_row == "npct_studydrug" ~ 2,
      table_row == "drug_days" ~ 3,
      table_row == "drug_doses" ~ 4,
      table_row == "npct_held" ~ 5,
      table_row == "npct_permdc" ~ 6,
      table_row == "npct_died" ~ 7,
      table_row == "npct_wd" ~ 8,
      table_row == "npct_elig" ~ 9,
      str_detect(table_row, "^npct\\_held\\_") ~ 10,
      str_detect(table_row, "^npct\\_permdc\\_") ~ 11,
      TRUE ~ 12),
    table_row = case_when(
      table_row == "randomized"              ~ "Randomized",
      table_row == "npct_studydrug"          ~ "Received >=1 dose study drug",
      table_row == "drug_days"               ~ "Days received study drug",
      table_row == "drug_doses"              ~ "Doses of study drug",
      table_row == "npct_held"               ~ "Ever had study drug temporarily held",
      table_row == "npct_permdc"             ~ "Had study drug permanently discontinued",
      table_row == "npct_died"               ~ "Died in the hospital",
      table_row == "npct_wd"                 ~ "Withdrew from study in the hospital",
      table_row == "npct_elig"               ~ "Eligible for long-term follow-up",
      table_row == "npct_held_ae"            ~ "Adverse event",
      table_row == "npct_held_dystonia"      ~ "Dystonia",
      table_row == "npct_held_eps"           ~ "Extrapyramidal symptoms",
      table_row == "npct_held_other"         ~ "Other reason",
      table_row == "npct_held_oversed"       ~ "Oversedation",
      table_row == "npct_held_qtc"           ~ "Prolonged QTc",
      table_row == "npct_held_refuseptfam"   ~ "Patient/family refusal",
      table_row == "npct_held_refuseteam"    ~ "Medical team refusal",
      table_row == "npct_permdc_ae"          ~ "Adverse event",
      table_row == "npct_permdc_coma"        ~ "Coma due to structural brain damage",
      table_row == "npct_permdc_nms"         ~ "NMS",
      table_row == "npct_permdc_other"       ~ "Other reason",
      table_row == "npct_permdc_react"       ~ "DRESS",
      table_row == "npct_permdc_refuseptfam" ~ "Patient/family refusal",
      table_row == "npct_permdc_refuseteam"  ~ "Medical team refusal",
      table_row == "npct_permdc_torsades"    ~ "Torsades de pointes",
      TRUE ~ "")
  ) %>%
  arrange(sort_order) %>%
  select(-sort_order)

```

```{r print_rand_table}
rand_table %>%
  kable(format = "html", col.names = c("", LETTERS[1:3]), align = c("l", rep("r", 3))) %>%
  mykablestyle %>%
  group_rows("Randomized Patients", 2, 9) %>%
  group_rows("Reasons Study Drug Temporarily Held", 10, 17) %>%
  group_rows("Reasons Study Drug Permanently Discontinued", 18, 25)

```

## Intervention by Dose

`r table_nums("intervention_dose", display = "cite")` describes the `r format(nrow(doses_df), big.mark = ",")` doses of study drug attempted during the course of the study. Study staff continued to document dose opportunities after permanent discontinuation; therefore, patients could have >1 dose in that category in this table.

[PLACEHOLDER TEXT TILL WE GET REAL TREATMENT GROUPS, ASSUMING TREATMENT MEANS NOTHING] About 75% of doses were successfully given in each of the three treatment groups, with rates of study drug hold and discontinuation approximately equal between groups. Pre-dose QTcs were also roughly equivalent between the three groups.

Oversedation was the most common reason for temporary hold by far; actual RASSes at the time of dose administration are listed in `r table_nums("intervention_dose", display = "cite")`. Refusal (patient, family, or medical team) was the most common reason for permanent discontinuation.

### `r table_nums("intervention_dose")`

```{r prep_dose_table}
## How many total doses in each treatment group?
doses_grp <- doses_df %>%
  ## Only interested in 1) randomized patients, and
  ##   2) doses not held/dc'd due to patient unavailability
  filter(id %in% rand_pts & (drug_given | drug_held | drug_permdc)) %>%
  group_by(trt) %>%
  summarise(doses_trt = n())

## Summarize variables that just need sums
dose_table <- doses_df %>%
  filter(id %in% rand_pts) %>%
  group_by(trt) %>%
  summarise(
    doses_given = sum_na(drug_given),
    doses_held = sum_na(drug_held),
    doses_permdc = sum_na(drug_permdc),
    type_initial = sum_na(dose_type == "Initial Starting Dose"),
    type_restart = sum_na(dose_type == "Restarting Dose"),
    type_increase = sum_na(dose_type == "Increased Dose"),
    type_decrease = sum_na(dose_type == "Decreased Dose"),
    type_maintmax = sum_na(dose_type == "Maintained at Maximum Dose"),
    type_maint = sum_na(dose_type == "Maintained"),
    type_other = sum_na(dose_type == "Other"),
    amt_025 = sum_na(dose_amt == 0.25),
    amt_050 = sum_na(dose_amt == 0.50),
    amt_100 = sum_na(dose_amt == 1.00),
    amt_200 = sum_na(dose_amt == 2.00),
    q25_preqtc = q25(pre_dose_qtc),
    q50_preqtc = q50(pre_dose_qtc),
    q75_preqtc = q75(pre_dose_qtc),
    mean_preqtc = mean_na(pre_dose_qtc),
    sd_preqtc = sd_na(pre_dose_qtc),
    held_qtc = sum_na(held_qtc),
    held_oversed = sum_na(held_oversed),
    rass_0 = sum_na(oversed_actual == "0"),
    rass_1 = sum_na(oversed_actual == "-1"),
    rass_2 = sum_na(oversed_actual == "-2"),
    rass_3 = sum_na(oversed_actual == "-3"),
    rass_4 = sum_na(oversed_actual == "-4"),
    rass_5 = sum_na(oversed_actual == "-5"),
    held_eps = sum_na(held_eps),
    held_dystonia = sum_na(held_dystonia),
    held_ae = sum_na(held_ae),
    held_refuseteam = sum_na(held_refuseteam),
    held_refuseptfam = sum_na(held_refuseptfam),
    held_other = sum_na(held_other),
    permdc_nms = sum_na(permdc_nms),
    permdc_react = sum_na(permdc_react),
    permdc_torsades = sum_na(permdc_torsades),
    permdc_coma = sum_na(permdc_coma),
    permdc_ae = sum_na(permdc_ae),
    permdc_refuseptfam = sum_na(permdc_refuseptfam),
    permdc_refuseteam = sum_na(permdc_refuseteam),
    permdc_other = sum_na(permdc_other)
  ) %>%
  ## Add total doses per treatment group; need these for denominators
  left_join(doses_grp, by = "trt") %>%
  ## -- Turn into a table ------------------------------------------------------
  ## Doses given
  mutate_at(
    vars(type_initial:amt_200), funs(get_npct(., denom = doses_given))
  ) %>%
  mutate(
    desc_preqtc = describe_cont(
      q50_preqtc, q25_preqtc, q75_preqtc, mean_preqtc, sd_preqtc
    )
  ) %>%
  ## Doses temporarily held
  mutate_at(vars(rass_0:rass_5), funs(get_npct(., denom = held_oversed))) %>%
  mutate_at(
    vars(held_qtc, held_oversed, held_eps:held_other),
    funs(get_npct(., denom = doses_held))
  ) %>%
  ## Doses permanently discontinued
  mutate_at(
    vars(permdc_nms:permdc_other), funs(get_npct(., denom = doses_permdc))
  ) %>%
  ## Do these last because we need the numeric versions for numerators
  mutate_at(
    vars(doses_given, doses_held, doses_permdc),
    funs(get_npct(., denom = doses_trt))
  ) %>%
  ## Transpose to one row per descriptor, with a column for each treatment group
  select(trt, doses_trt, doses_given:doses_permdc, type_initial:amt_200,
         desc_preqtc, held_qtc:held_other, rass_0:rass_5,
         permdc_nms:permdc_other) %>%
  gather(key = table_row, value = dose_value, -trt) %>%
  spread(key = trt, value = dose_value) %>%
  ## Table formatting
  mutate(
    sort_order = case_when(
      table_row == "doses_trt" ~ 1,
      table_row == "doses_given" ~ 2,
      table_row == "doses_held" ~ 3,
      table_row == "doses_permdc" ~ 4,
      table_row == "amt_025" ~ 5,
      table_row == "amt_050" ~ 6,
      table_row == "amt_100" ~ 7,
      table_row == "amt_200" ~ 8,
      table_row == "type_initial" ~ 9,
      table_row == "type_restart" ~ 10,
      table_row == "type_decrease" ~ 11,
      table_row == "type_increase" ~ 12,
      table_row == "type_maint" ~ 13,
      table_row == "type_maintmax" ~ 14,
      table_row == "type_other" ~ 15,
      table_row == "desc_preqtc" ~ 16,
      table_row == "held_ae" ~ 17,
      table_row == "held_dystonia" ~ 18,
      table_row == "held_eps" ~ 19,
      table_row == "held_oversed" ~ 20,
      table_row == "held_qtc" ~ 21,
      table_row == "held_refuseptfam" ~ 22,
      table_row == "held_refuseteam" ~ 23,
      table_row == "held_other" ~ 24,
      table_row %in% paste0("rass_", 0:5) ~ 25,
      table_row == "permdc_ae" ~ 26,
      table_row == "permdc_coma" ~ 27,
      table_row == "permdc_nms" ~ 28,
      table_row == "permdc_react" ~ 29,
      table_row == "permdc_torsades" ~ 30,
      table_row == "permdc_refuseptfam" ~ 31,
      table_row == "permdc_refuseteam" ~ 32,
      table_row == "permdc_other" ~ 33,
      TRUE ~ 34
    ),
    table_row = case_when(
      table_row == "doses_trt" ~ "Dose Opportunities",
      table_row == "doses_given" ~ "Given",
      table_row == "doses_held" ~ "Temporarily held",
      table_row == "doses_permdc" ~ "Permanently discontinued",
      table_row == "amt_025" ~ "0.25 mL",
      table_row == "amt_050" ~ "0.50 mL",
      table_row == "amt_100" ~ "1.00 mL",
      table_row == "amt_200" ~ "2.00 mL",
      table_row == "type_initial" ~ "Initial starting dose",
      table_row == "type_restart" ~ "Restarting dose",
      table_row == "type_decrease" ~ "Decrease",
      table_row == "type_increase" ~ "Increase",
      table_row == "type_maint" ~ "Maintained (med. induced coma)",
      table_row == "type_maintmax" ~ "Maintained at max dose",
      table_row == "type_other" ~ "Other",
      table_row == "desc_preqtc" ~ "Pre-dose QTc",
      table_row == "held_ae" ~ "Adverse event",
      table_row == "held_dystonia" ~ "Dystonia",
      table_row == "held_eps" ~ "Extrapyramidal symptoms",
      table_row == "held_oversed" ~ "Oversedation",
      table_row == "held_qtc" ~ "Prolonged QTc",
      table_row == "held_refuseptfam" ~ "Patient/family refusal",
      table_row == "held_refuseteam" ~ "Medical team refusal",
      table_row == "held_other" ~ "Other",
      table_row == "rass_0" ~ "0",
      table_row %in% paste0("rass_", 1:5) ~
        paste0("-", gsub("^rass\\_", "", table_row)),
      table_row == "permdc_ae" ~ "Adverse event",
      table_row == "permdc_coma" ~ "Coma due to structural brain damage",
      table_row == "permdc_nms" ~ "NMS",
      table_row == "permdc_react" ~ "DRESS",
      table_row == "permdc_torsades" ~ "Torsades de pointes",
      table_row == "permdc_refuseptfam" ~ "Patient/family refusal",
      table_row == "permdc_refuseteam" ~ "Medical team refusal",
      table_row == "permdc_other" ~ "Other",
      TRUE ~ "fix this!"
    )
  ) %>%
  arrange(sort_order) %>%
  select(-sort_order)

```

```{r print_dose_table}
dose_table %>%
  kable(format = "html", col.names = c("", LETTERS[1:3]), align = c("l", rep("r", 3))) %>%
  mykablestyle %>%
  group_rows("All Dose Opportunities", 2, 4) %>%
  group_rows("Doses Given", 5, 16) %>%
  group_rows("Doses Temporarily Held", 17, 24) %>%
  group_rows("Actual RASS for Doses Held due to Oversedation", 25, 30) %>%
  group_rows("Doses Permanently Discontinued", 31, 38)

```
