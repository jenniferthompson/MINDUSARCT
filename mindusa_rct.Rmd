---
title: "Primary In-Hospital Outcomes Analysis of the MIND-USA Clinical Trial"
author: "Jennifer L Thompson, MPH; Supervisor: Rameela Chandrasekhar, PhD"
output:
  html_document:
    theme: flatly
    highlight: tango
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
---

<script>
$(document).ready(function(){
    $('[data-toggle="popover"]').popover(); 
});
</script>

The MIND-USA clinical trial aims to define the role of antipsychotics in the management of delirium in critically ill patients, specifically comparing haloperidol (typical antipsychotic) and ziprasidone (atypical antipsychotic) to placebo. Further details can be found in the trial listing on [clinicaltrials.gov](https://clinicaltrials.gov/ct2/show/NCT01211522).

```{r setup, results = "hide", warning = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(purrr))
suppressPackageStartupMessages(library(forcats))
suppressPackageStartupMessages(library(stringr))
suppressPackageStartupMessages(library(glue))
suppressPackageStartupMessages(library(kableExtra))
suppressPackageStartupMessages(library(captioner))
suppressPackageStartupMessages(library(rms))
suppressPackageStartupMessages(library(naniar))
suppressPackageStartupMessages(library(sparkline))
suppressPackageStartupMessages(library(survminer))
suppressPackageStartupMessages(library(cmprsk))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(ggthemr)) ## Github only; cttobin/ggthemr
suppressPackageStartupMessages(library(JTHelpers))
  ## Github only; jenniferthompson/JTHelpers

## Hmisc setup for nicely printing summaryM output
mu <- markupSpecs$html

## Levels for sorting factor versions of treatment
## (A-C used for coding prior to treatment blind being broken)
trt_levels <- data.frame(
  trt_num = 1:3,
  trt_abc = LETTERS[1:3],
  trt_actual = c("Placebo", "Haloperidol", "Ziprasidone")
)

## -- ggplot palette/custom theme ----------------------------------------------
# ## Picked colors from/inspired by Flatly theme
# palette_colors <- c(
#   "dred"    = "#EA513B",
#   "dgreen"  = "#00BE9D",
#   "dblue"   = "#2595D6",
#   "dyellow" = "#F89B2F",
#   "lred"    = "#EF7A69",
#   "lgreen"  = "#00F1C7",
#   "lblue"   = "#4EAAE0",
#   "lyellow" = "#FAB360",
#   "dgray"   = "#2E3F4F",
#   "lgray"   = "#92A3A3"
# )

## Started with Flatly theme colors, moved to some I liked better
palette_colors <- c(
  "dpurple" = "#242249",
  "dred"    = "#B40F20",
  "dgray"   = "#2E3F4F",
  "dgreen"  = "#74A089",
  "dblue"   = "#1D77AB",
  "dyellow" = "#F89B2F",
  "lred"    = "#EF7A69",
  "lgreen"  = "#00F1C7",
  "lblue"   = "#4EAAE0",
  "lyellow" = "#FAB360",
  "lgray"   = "#92A3A3"
)

## Use ggthemr to define the full palette
mindusa_palette <- ggthemr::define_palette(
  swatch = as.character(palette_colors),
  gradient = c(
    lower = "#F8CD2F",
    upper = as.character(palette_colors["dblue"]))
)

## Set ggplot2 theme options directly
basetext_size <- 13
mindusa_theme <- function(base_size = basetext_size){
  theme_bw(base_size = base_size, base_family = "Lato") +
    theme(
      text = element_text(colour = as.character(palette_colors["dgray"])),
      plot.title = element_text(face = "bold"),
      plot.caption = element_text(face = "italic"),
      panel.grid.major = element_line(colour = "#E7E9E9"),
      panel.grid.minor = element_line(colour = "#F4F5F5"),
      legend.position = "bottom",
      legend.direction = "horizontal",
      strip.text = element_text(
        face = "bold", colour = as.character(palette_colors["dgray"])
      ),
      strip.background = element_rect(
        colour = as.character(palette_colors["dgray"]), fill = "#B9C3C4"
      )
    )
}

## Set final palette, theme
ggthemr(mindusa_palette)
theme_set(mindusa_theme())

# ## Test it out
# ggplot(data = iris, aes(x = Sepal.Length)) +
#   facet_wrap(~ Species) +
#   geom_histogram(aes(fill = Species), binwidth = 1) +
#   labs(
#     title = "This is a test plot",
#     subtitle = "With iris data.",
#     caption = "Everyone loves iris data."
#   )
# 
# ggplot(data = iris, aes(x = Sepal.Length, y = Sepal.Width)) +
#   geom_point(aes(colour = Petal.Length)) +
#   labs(title = "Testing out continuous scale")

## Source general helper functions
source("mindusa_rct_helpers.R")

## Source functions for adjusted quantiles from orm() model fits
source("orm_functions.R")

```

```{r captions, results = "hide"}
## -- Table and figure captions ------------------------------------------------
table_nums <- captioner(prefix = "Table")
fig_nums <- captioner(prefix = "Figure")

table_nums(
  name = "screening", caption = "Overview of Screening, Exclusions & Randomization"
)
table_nums(name = "exclusions", caption = "Study Exclusions")
table_nums(name = "exc_other", caption = "'Other' Exclusions")
table_nums(
  name = "baseline_all",
  caption = "Demographic & ICU Admission Characteristics, All Consented Patients"
)
table_nums(
  name = "baseline_trt",
  caption = "Demographic & ICU Admission Characteristics, Randomized Patients"
)
table_nums(
  name = "icursn_other", caption = "Descriptions of 'Other' ICU Admission Reasons"
)
table_nums(
  name = "inhosp_trt",
  caption = "Intervention Period Characteristics by Treatment Group"
)
table_nums(
  name = "intervention_pt", caption = "Description of Intervention by Patient"
)
table_nums(
  name = "intervention_dose",
  caption = "Description of Intervention by Study Drug Dose"
)
table_nums(
  name = "dose_held_other",
  caption = "Reasons for Temporary Study Drug Hold due to 'Other'"
)
table_nums(
  name = "dose_permdc_other",
  caption = "Reasons for Study Drug Discontinuation due to 'Other'"
)
table_nums(name = "dcfd_orci", caption = "Adjusted Odds Ratios (95% CI), DCFDs")
table_nums(name = "dcfd_meds", caption = "Adjusted Medians (95% CI), DCFDs")

table_nums('package_info', caption = "Software Details")

fig_nums(
  name = "dcfds_unadj",
  caption = "Delirium/Coma-Free Days by Treatment Group"
)

```

```{r data_setup, results = "hide"}
## Analysis datasets are stored in an .Rdata file, originally created and stored
##  by create_rctdata.R in ../MINDUSADataMgmt.
load("analysisdata/rct.Rdata")

## How many patients were randomized?
n_rand <- length(rand_pts)

## Add treatment groups to datasets as needed
rand_df$trt <- factor(
  rand_df$trt, levels = c("Placebo", "Haloperidol", "Ziprasidone")
)
ptsummary_df <- left_join(ptsummary_df, rand_df, by = "id")

## Create an indicator for whether randomized patients got antipsychotics
## *either* between ICU admission & consent, or between consent & randomization
## ICU admission -> consent: ptsummary_df$antipsyc_adm
## Consent -> randomization/DQ: ptsummary_df$antipsyc_ever_pr
ptsummary_df$antipsyc_adm_pr <- with(ptsummary_df, {
  antipsyc_adm | (!is.na(antipsyc_ever_pr) & antipsyc_ever_pr)
})

```

# Screening, Consent, and Randomization

<hr>

Because this trial aims to describe the association between antipsychotics and treatment of delirium (rather than prevention), patients were required to be delirious prior to being randomized to study drug. In order to treat delirium immediately upon it being observed, however, patients (or their surrogates) were consented as soon as they met study inclusion criteria and were found not to meet exclusion criteria.

Upon consent, patients could be randomized any time in the following five days, provided: no exclusions were met within that time; the patient remained in the ICU; and they did eventually become delirious. Patients are considered "disqualified" if they left the ICU or the study (via discharge, death, or withdrawal) prior to experiencing delirium, or never experienced delirium in the five days following consent.

```{r prep_screen_table}
## -- Create a data frame with rows = various categories of patients -----------
## --  (screened, consented, etc), along with N, % of patients in each ---------

## Get total N in each category; result = df with 1 row, columns = categories
## This will be added to a "vertical" data.frame to use as denominators
screen_ns <- ptstatus_df %>%
  ## Only include patients who met screening criteria
  filter(screened) %>%
  ## Create indicators for each reason for disqualification; patients
  ## disqualified for meeting exclusion criteria are included in "excluded after
  ## consent" and will not be listed here
  mutate(
    dq_nodel = ifelse(!disqualified, NA, dq_reason == "No delirium within 5 days"),
    dq_icudc = ifelse(!disqualified, NA, dq_reason == "ICU discharge before delirium"),
    dq_diedwd = ifelse(!disqualified, NA, dq_reason == "Died/withdrew before delirium")
  ) %>%
  ## Select the categories we want
  dplyr::select(
    screened, excluded_imm, approached, refused, consented, excluded_later,
     disqualified, randomized, dq_nodel, dq_icudc, dq_diedwd,
    matches("^rand\\_"), -rand_list
  ) %>%
  summarize_all(sum, na.rm = TRUE)

## Create data.frame for final table, starting with horizontal df
screen_table <- screen_ns %>%
  ## Transpose to one row per category
  gather(key = "status", value = "npts") %>%
  ## Add potential denominators from horizontal df (need to replicate original
  ##  to get the same number of rows)
  bind_cols(bind_rows(rep(list(screen_ns), nrow(.)))) %>%
  mutate(
    ## Determine appropriate denominator for each category %
    denom = ifelse(status %in% c("excluded_imm", "approached"), screened,
            ifelse(status %in% c("refused", "consented"), approached,
            ifelse(status %in% c("excluded_later", "randomized", "disqualified"),
                   consented,
            ifelse(substr(status, 1, 4) == "rand", randomized,
            ifelse(substr(status, 1, 2) == "dq", disqualified, NA))))),
    ## Calculate %
    pctpts = round((npts / denom) * 100),
    ## More informative statuses
    status_label = case_when(
      status == "screened"       ~ "Screened within 72 hours of meeting inclusion criteria",
      status == "excluded_imm"   ~ "Excluded immediately (details below)",
      status == "approached"     ~ "Staff approached patient/surrogate",
      status == "refused"        ~ "Patient/surrogate refused consent",
      status == "consented"      ~ "Consented for study",
      status == "excluded_later" ~ "Excluded after consent (details below)",
      status == "disqualified"   ~ "Ineligible for randomization",
      status == "randomized"     ~ "Randomized to study drug",
      status == "rand_mv"        ~ "Mechanical ventilation",
      status == "rand_nippv"     ~ "Non-invasive positive pressure ventilation (NIPPV)",
      status == "rand_shock"     ~ "Requiring treatment for shock",
      status == "dq_nodel"       ~ "No delirium in 5 days after consent",
      status == "dq_icudc"       ~ "ICU discharge prior to delirium",
      status == "dq_diedwd"      ~ "Died/withdrew prior to delirium",
      TRUE ~ status
    ),
    ## Create character string with N (%)
    npct = ifelse(is.na(pctpts), format_comma(npts),
                  sprintf("%s (%s%%)", format_comma(npts), pctpts))
  ) %>%
  dplyr::select(status_label, npct)

## When did screening take place? Find first and last month
screening_months <- ptstatus_df %>%
  dplyr::select(screened, exc_month, exc_year, enroll_month, enroll_year) %>%
  mutate(screen_month = ifelse(!is.na(exc_month), exc_month, enroll_month),
         screen_year = ifelse(!is.na(exc_year), exc_year, enroll_year)) %>%
  filter(screened & !is.na(screen_month)) %>%
  arrange(screen_year, screen_month) %>%
  slice(c(1, n())) %>%
  mutate(monthyr = paste(month.name[screen_month], screen_year))

first_month <- screening_months %>% slice(1) %>% pull(monthyr)
last_month <- screening_months %>% slice(n()) %>% pull(monthyr)

```

## Overview of Screening, Exclusions and Randomization

`r table_nums("screening", display = "cite")` presents patient flow information for the `r format_comma(sum_na(ptstatus_df$screened))` patients who were screened with 72 hours of meeting inclusion criteria. Screening took place between `r first_month` and `r last_month`.

### Note on ITT Population

When the treatment blind was broken, we discovered that `r with(ptstatus_df, sum(rand_list & !randomized))` patients who never met criteria for randomization
had been assigned a treatment group that was never enacted. This assignment was
done in the pharmacy only, with no study drug ever sent, no intervention done,
and no outcomes tracked for these patients. Because these patients never met
randomization criteria, they were never intended to be randomized or treated by
site coordinators, and thus had no outcomes data tracked. They are included in
the "Ineligible for Randomization" group below and are *not* included in the
intent-to-treat population. The `r with(ptsummary_df, sum(randomized & !ever_studydrug))` patients who were randomized but never received a dose of
study drug *are* included in the ITT population.

```{r print_screen_table}
screen_table %>%
  kable(format = "html", col.names = c("", "N (%)"), align = c("l", "r")) %>%
  mykablestyle %>%
  group_rows("Screened Patients", 2, 3) %>%
  group_rows("Approached Patients", 4, 5) %>%
  group_rows("Consented Patients", 6, 8) %>%
  group_rows("Reasons for Ineligibility", 9, 11) %>%
  group_rows("Organ Failures Present at Randomization", 12, 14) %>%
  row_spec(grep("^Randomized", screen_table$status_label), bold = TRUE)

```

**Note**: Patients could have none, one, or two of the listed organ failures present at randomization; percentages will not add up to 100%.

## Study Exclusions

```{r prep_exclusions}
## Some exclusions aren't relevant for our purposes here:
## - Rapidly resolving organ failure, 72h eligibility period exceeded:
##     indicates patient did not meet screening criteria
## - Patient/surrogate refusal: not considered a study exclusion
## We're also interested in the *combined* version of some:
## - pregnancy + breast feeding (2a, 2b); look at exc_2 instead
## - all exclusions relating to time running out (9c, e, f); look at exc_9cef
exclusion_rsns <- paste0(
  "exc_",
  c("2_pregbf", "34_neuro", "5_torsadesqtc", "6_maintmeds", "7_nmsallergy",
    "8_death24", "9a_refusal_md", "9cef_time", "10_blind_lang", "11_prison",
    "12_coenroll", "13_iqcode", "14_screen", "99_other")
)

exc_table <- ptstatus_df %>%
  ## Select only exclusion indicators (overall + specific exclusions)
  dplyr::select(id, matches("^excluded\\_"), one_of(exclusion_rsns)) %>%
  
  ## Reshape to long format: one row per "time" of exclusion (ever, screening,
  ##  after consent)
  gather(key = "when", value = "excluded", excluded_imm:excluded_ever) %>%
  
  ## Count only patients who were actually excluded
  filter(excluded) %>%
  
  ## Get count of each exclusion by time point
  group_by(when) %>%
  summarise_at(vars(-id), sum_na) %>%
  ungroup %>%
  
  ## Reshape to long format: one row per time + exclusion
  gather(key = "exclusion", value = "nexc", matches("^exc\\_[0-9]+")) %>%
  
  mutate(
    ## Calculate % of exclusions at each time point for each possible exclusion
    pctexc = round((nexc / excluded) * 100),
    ## Formatting/text work
    npct = sprintf("%s (%s%%)", format_comma(nexc), pctexc),
    when = gsub("^excluded\\_", "", when),
    exclusion = case_when(
      exclusion == "exc_2_pregbf"      ~ "Pregnancy or breast feeding",
      exclusion == "exc_34_neuro"      ~ "Severe dementia or neurodegenerative disease",
      exclusion == "exc_5_torsadesqtc" ~ "History of Torsades or prolonged QTc",
      exclusion == "exc_6_maintmeds"   ~ "Maintenance therapy with antipsychotics/lithium",
      exclusion == "exc_7_nmsallergy"  ~ "History of NMS or allergy to study drugs",
      exclusion == "exc_8_death24"     ~ "Expected death within 24 hours",
      exclusion == "exc_9a_refusal_md" ~ "Attending physician refusal",
      exclusion == "exc_9cef_time"     ~ "No surrogate available within window",
      exclusion == "exc_10_blind_lang" ~ "Blind, deaf, or unable to speak English",
      exclusion == "exc_11_prison"     ~ "Incarceration",
      exclusion == "exc_12_coenroll"   ~ "Enrolled in a study ineligible for co-enrollment",
      exclusion == "exc_13_iqcode"     ~ "IQCODE score >= 4.5",
      exclusion == "exc_14_screen"     ~ "Screening failure",
      TRUE ~ "Other exclusion"
    )
  ) %>%
  dplyr::select(exclusion, when, npct) %>%
  spread(key = when, value = npct) %>%
  arrange(desc(as.numeric(gsub(",", "", gsub(" \\([0-9]+\\%\\)$", "", ever)))))

exc_colheads <- c(
  "Exclusion",
  sprintf("Ever\\\n(N = %s)", format_comma(sum_na(ptstatus_df$excluded_ever))),
  sprintf("At Screening\\\n(N = %s)", format_comma(sum_na(ptstatus_df$excluded_imm))),
  sprintf("After Consent\\\n(N = %s)", format_comma(sum_na(ptstatus_df$excluded_later)))
)

```

Exclusions could take place at the time of screening (vast majority), or after
consent, if a patient was determined to have cognitive disability (indicated by
an IQCODE score >= 4.5) or was discovered to have an exclusion criteria prior to
randomization. For the `r format_comma(sum_na(ptstatus_df$excluded_ever))`
patients excluded from MINDUSA, `r table_nums("exclusions", display = "cite")`
presents exclusions:

1. At any point (column 1; % out of all exclusions)
1. At the time of screening (column 2; % out of all screening exclusions)
1. After consent (column 3; % out of all post-consent exclusions)

Patients could meet multiple exclusion criteria; therefore, column percentages may total more than 100%.

```{r print_exc_table}
exc_table %>%
  kable(format = "html", col.names = exc_colheads, align = c("l", rep("r", 3))) %>%
  mykablestyle(stripes = TRUE)

```

### "Other" Exclusions

To save space, reasons for "other" exclusions are collapsed below. (These
explanations are taken directly from our database; potentially identifiable
information, including dates, times and parenthetical details, have been
redacted to preserve patient privacy.)

<details>
<summary>Reasons for "Other" Exclusions</summary>
```{r exc_other_table}
ptstatus_df %>%
  filter(exc_99_other) %>%
  dplyr::select(exc_other) %>%
  kable(
    format = "html",
    col.names = c("Explanation for 'other' exclusion"), align = c("l")
  ) %>%
  mykablestyle

```

</details>

# Descriptions of the Cohorts

<hr>

Our study design was such that a substantial number of patients gave consent to be in the study, but were unable to be randomized. Thus, we describe demographics and ICU admission characteristics of all consented patients, comparing those randomized to those not randomized (`r table_nums("baseline_all", display = "cite")`), and then describe those characteristics, as well as the course of hospitalization, by treatment group among randomized patients only (`r table_nums("baseline_trt", display = "cite")` and `r table_nums("inhosp_trt", display = "cite")`).

## Randomized vs Non-Randomized Patients

Since no further information was collected on patients who were unable to be randomized, we can only describe demographic and ICU admission characteristics of these patients. `r table_nums("baseline_all", display = "cite")` describes these characteristics for both all consented patients, and separately for patients who were and were not able to be randomized.

### Demographic & ICU Admission Characteristics, All **Consented** Patients

**Note on the AUDIT:** This questionnaire was developed for administration to the patient directly; out of necessity, we often administered it to surrogates, leading to missing data if a surrogate was unsure about the answer to a particular question. We have therefore calculated the score in two different ways: 1) if any question is missing the total is missing; and 2) any missing questions are assumed to have a score of 0.

```{r baseline_all}
## Do things to make the table pretty: Factor version of rand. indicator, labels
ptsummary_all_df2 <- ptsummary_all_df %>%
  left_join(rand_df, by = "id") %>%
  mutate(
    randomized_f = factor(
      as.numeric(ptsummary_all_df$randomized),
      levels = 0:1,
      labels = c("Not Randomized", "Randomized")
    )
  ) %>%
  mutate_at(
    vars(enroll_mv, enroll_nippv, enroll_shock),
    funs(factor(as.numeric(.), levels = 0:1, labels = c("No", "Yes")))
  )
    
label(ptsummary_all_df2$enroll_mv) <- "On invasive MV at consent"
label(ptsummary_all_df2$enroll_nippv) <- "On NIPPV at consent"
label(ptsummary_all_df2$enroll_shock) <- "Treatment for shock at consent"
label(ptsummary_all_df2$age_consent) <- "Age at consent"
label(ptsummary_all_df2$gender) <- "Gender"
label(ptsummary_all_df2$race_cat) <- "Race"
label(ptsummary_all_df2$ethnicity) <- "Ethnicity"
label(ptsummary_all_df2$english_level) <- "Fluency in English"
label(ptsummary_all_df2$education) <- "Education"
label(ptsummary_all_df2$insurance) <- "Insurance"
label(ptsummary_all_df2$bmi) <- "BMI"
label(ptsummary_all_df2$home_antipsyc) <- "On antipsychotics prior to admission"
label(ptsummary_all_df2$charlson_total) <- "Charlson Comorbidities Index"
label(ptsummary_all_df2$iqcode_total_ph) <- "IQCODE total score"
label(ptsummary_all_df2$adl_total_ph) <- "Katz Activities of Daily Living total score"
label(ptsummary_all_df2$faq_total_ph) <- "Functional Activities Questionnaire total score"
label(ptsummary_all_df2$audit_total_ph_complete) <-
  "AUDIT total score; incomplete questions considered missing"
label(ptsummary_all_df2$audit_total_ph_partial) <-
  "AUDIT total score; incomplete questions considered normal"
label(ptsummary_all_df2$frailty_f) <- "CSHA Clinical Frailty Score"
label(ptsummary_all_df2$icu_rsn) <- "Primary reason for ICU admission"
label(ptsummary_all_df2$sofa_adm) <- "SOFA at ICU admission (imputed data)"
label(ptsummary_all_df2$cv_sofa_adm_f) <- "Cardiovascular SOFA at ICU admission"
label(ptsummary_all_df2$sofa_imp_consent) <- "SOFA on day of consent (imputed data)"
label(ptsummary_all_df2$cv_sofa_consent) <- "Cardiovascular SOFA on day of consent"
label(ptsummary_all_df2$apache_adm) <- "APACHE II at ICU admission"

## Formula we'll use for both demographic/admission tables
admit_formula_lhs <- "enroll_mv + enroll_nippv + enroll_shock + age_consent + gender + race_cat + ethnicity + english_level + education + iqcode_total_ph + adl_total_ph + faq_total_ph + audit_total_ph_complete + audit_total_ph_partial + frailty_f + insurance + bmi + home_antipsyc + charlson_total + frailty_f + icu_rsn + apache_adm + sofa_adm + cv_sofa_adm_f + sofa_imp_consent + cv_sofa_consent"

my_html(
  summaryM(as.formula(paste(admit_formula_lhs, "randomized_f", sep = " ~ ")),
           data = ptsummary_all_df2,
           overall = TRUE),
  caption = "Demographic & ICU Admission Characteristics of Consented Patients"
)

```

## Randomized Patients by Treatment Group

The following tables describe demographic and ICU admission characteristics (`r table_nums("baseline_trt", display = "cite")`) and in-hospital characteristics (`r table_nums("inhosp_trt", display = "cite")`) of all randomized patients.

### Demographic & ICU Admission Characteristics, All **Randomized** Patients

```{r baseline_trt}
my_html(
  summaryM(as.formula(paste(admit_formula_lhs, "trt", sep = " ~ ")),
           data = subset(ptsummary_all_df2, randomized)),
  caption = "Demographic & ICU Admission Characteristics of Randomized Patients"
)

```

### Descriptions of "Other" ICU Admission Reasons

To save space, reasons for "other" ICU admission among randomized patients are collapsed.

<details>
<summary>"Other" Reasons for ICU Admission</summary>
```{r icursn_other_table}
ptsummary_all_df %>%
  filter(randomized & icu_rsn == "Other") %>%
  dplyr::select(icu_rsn_other) %>%
  kable(
    format = "html",
    col.names = c("Explanation for 'other' ICU admission reason"),
    align = c("l")
  ) %>%
  mykablestyle

```

</details>

### Intervention Period Characteristics by Treatment Group

Unless otherwise specified, quantities in this table reflect the 14 days
including and following randomization (the "study period"). Additional notes:

- "Liberation from mechanical ventilation" variables apply only to patients who
were on either type of MV when randomized, or were placed on MV within the 24
hours following randomization.
- All time-to-event descriptions (eg, ICU length of stay) begin at the time of
randomization and go through the entire hospitalization (even if the patient
remained hospitalized after the intervention period).
- "Antipsychotics" refers not only to open-label haloperidol and ziprasidone,
but *any* antipsychotic, including quetiapine, aripiprazole, olanzapine, and
risperidone. Doses are converted to haloperidol equivalents.
- "Benzodiazepines" includes midazolam, lorazepam, and diazepam, all converted
to midazolam equivalents.
- "Opioids" includes fentanyl, remifentanil, morphine, and hydromorphone, all
converted to fentanyl equivalents.

All drug conversion formulas can be found [here](https://docs.google.com/spreadsheets/d/1ZGfxAmTFxGgfzjwE0trrpKEn_21QDwCSGJIv-E5kiE4/edit?usp=drivesdk).

```{r inhosp_trt}
## Which variables do we want for *all* drugs?
medsum_vars <- c("ever_int", "days_exp_int", "total_exp_int", "mean_exp_int")

inhosp_vars <- c(
  "antipsyc_adm_pr", "sofa_imp_rand", "cv_sofa_rand", "ever_mv", "days_mv_exp",
  "mv_num", "int_num", "noninv_num", "on_mv_rand24", "ever_mvlib_rand24",
  "daysto_mvlib_exp", "sepsis", "stroke",
  paste("benzo", medsum_vars, sep = "_"),
  paste("opioid", medsum_vars, sep = "_"),
  paste("propofol", medsum_vars, sep = "_"),
  paste("halop", medsum_vars, sep = "_"),
  paste("zipras", medsum_vars, sep = "_"),
  paste("antipsyc", medsum_vars, sep = "_"),
  "sofa_imp_max_int", "sofa_imp_min_int", "sofa_imp_mean_int",
  "ever_del_int", "del_int_exp", "ever_coma_int", "coma_int_exp",
  "ever_delcoma_int", "delcoma_int_exp", "dcfd_int",
  "icu_los", "icu_readmit_number", "hosp_los", "dc_status", "hospdis_loc"
)

## Create new dataset with variable labels, factors
inhosp_desc_df <- ptsummary_df %>%
  mutate(
    antipsyc_adm_pr = factor_tf(antipsyc_adm_pr),
    ever_mv = factor_tf(ever_mv),
    on_mv_rand24 = factor_tf(on_mv_rand24),
    ever_mvlib_rand24 = factor_tf(ever_mvlib_rand24),
    benzo_ever_int = factor_tf(benzo_ever_int),
    opioid_ever_int = factor_tf(opioid_ever_int),
    propofol_ever_int = factor_tf(propofol_ever_int),
    dex_ever_int = factor_tf(dex_ever_int),
    halop_ever_int = factor_tf(halop_ever_int),
    zipras_ever_int = factor_tf(zipras_ever_int),
    antipsyc_ever_int = factor_tf(antipsyc_ever_int),
    ever_del_int = factor_tf(ever_del_int),
    ever_coma_int = factor_tf(ever_coma_int),
    ever_delcoma_int = factor_tf(ever_delcoma_int)
  )
label(inhosp_desc_df$antipsyc_adm_pr) <-
  "Received open-label antipsychotics between ICU admission and randomization"
label(inhosp_desc_df$sofa_imp_rand) <-
  "SOFA on day of randomization (imputed data)"
label(inhosp_desc_df$cv_sofa_rand) <-
  "Cardiovascular SOFA on day of randomization"
label(inhosp_desc_df$ever_mv) <- "Ever on mechanical ventilation (either type)"
label(inhosp_desc_df$days_mv_exp) <-
  "Days on mechanical ventilation (either type)"
label(inhosp_desc_df$mv_num) <- "Times MV initiated (either type)"
label(inhosp_desc_df$int_num) <- "Number of intubations"
label(inhosp_desc_df$noninv_num) <- "Times NIPPV initiated"
label(inhosp_desc_df$on_mv_rand24) <- "On MV at or within 24h of randomization"
label(inhosp_desc_df$ever_mvlib_rand24) <-
  "Ever successfully liberated from MV at randomization"
label(inhosp_desc_df$daysto_mvlib_exp) <-
  "Days to successful liberation from MV"
label(inhosp_desc_df$sepsis) <-
  "Met criteria for sepsis on or before Intervention Day 18"
label(inhosp_desc_df$stroke) <- "Had a stroke during hospitalization"
label(inhosp_desc_df$benzo_ever_int) <- "Received benzodiazepines"
label(inhosp_desc_df$benzo_days_exp_int) <-
  "Days received benzodiazepines, if at all"
label(inhosp_desc_df$benzo_total_exp_int) <-
  "Total dose of benzodiazepines, if any"
label(inhosp_desc_df$benzo_mean_exp_int) <-
  "Mean daily dose of benzodiazepines on days received"
label(inhosp_desc_df$opioid_ever_int) <- "Received opioids"
label(inhosp_desc_df$opioid_days_exp_int) <- "Days received opioids, if at all"
label(inhosp_desc_df$opioid_total_exp_int) <- "Total dose of opioids, if any"
label(inhosp_desc_df$opioid_mean_exp_int) <-
  "Mean daily dose of opioids on days received"
label(inhosp_desc_df$propofol_ever_int) <- "Received propofol"
label(inhosp_desc_df$propofol_days_exp_int) <- "Days received propofol, if at all"
label(inhosp_desc_df$propofol_total_exp_int) <- "Total dose of propofol, if any"
label(inhosp_desc_df$propofol_mean_exp_int) <-
  "Mean daily dose of propofol on days received"
label(inhosp_desc_df$dex_ever_int) <- "Received dexmedetomidine"
label(inhosp_desc_df$dex_days_exp_int) <- "Days received dexmedetomidine, if at all"
label(inhosp_desc_df$dex_total_exp_int) <- "Total dose of dexmedetomidine, if any"
label(inhosp_desc_df$dex_mean_exp_int) <-
  "Mean daily dose of dexmedetomidine on days received"
label(inhosp_desc_df$halop_ever_int) <- "Received open-label haloperidol"
label(inhosp_desc_df$halop_days_exp_int) <-
  "Days received open-label haloperidol, if at all"
label(inhosp_desc_df$halop_total_exp_int) <-
  "Total dose of open-label haloperidol, if any"
label(inhosp_desc_df$halop_mean_exp_int) <-
  "Mean daily dose of open-label haloperidol on days received"
label(inhosp_desc_df$zipras_ever_int) <- "Received open-label ziprasidone"
label(inhosp_desc_df$zipras_days_exp_int) <-
  "Days received open-label ziprasidone, if at all"
label(inhosp_desc_df$zipras_total_exp_int) <-
  "Total dose of open-label ziprasidone, if any"
label(inhosp_desc_df$zipras_mean_exp_int) <-
  "Mean daily dose of open-label ziprasidone on days received"
label(inhosp_desc_df$antipsyc_ever_int) <- "Received open-label antipsychotics"
label(inhosp_desc_df$antipsyc_days_exp_int) <-
  "Days received open-label antipsychotics, if at all"
label(inhosp_desc_df$antipsyc_total_exp_int) <-
  "Total dose of open-label antipsychotics, if any"
label(inhosp_desc_df$antipsyc_mean_exp_int) <-
  "Mean daily dose of open-label antipsychotics on days received"
label(inhosp_desc_df$sofa_imp_max_int) <- "Highest daily SOFA"
label(inhosp_desc_df$sofa_imp_min_int) <- "Lowest daily SOFA"
label(inhosp_desc_df$sofa_imp_mean_int) <- "Mean daily SOFA"
label(inhosp_desc_df$ever_del_int) <- "Experienced delirium"
label(inhosp_desc_df$del_int_exp) <- "Days of delirium"
label(inhosp_desc_df$ever_coma_int) <- "Experienced coma"
label(inhosp_desc_df$coma_int_exp) <- "Days of coma"
label(inhosp_desc_df$ever_delcoma_int) <- "Experienced delirium and/or coma"
label(inhosp_desc_df$delcoma_int_exp) <- "Days of delirium and/or coma"
label(inhosp_desc_df$dcfd_int) <-
  "Delirium/coma-free days (missing days imputed)"
label(inhosp_desc_df$icu_los) <-
  "Total length of ICU stay (entire hospitalization)"
label(inhosp_desc_df$icu_readmit_number) <-
  "Number of ICU readmissions during hospitalization"
label(inhosp_desc_df$hosp_los) <- "Total length of hospitalization"
label(inhosp_desc_df$dc_status) <- "Status at end of hospitalization"
label(inhosp_desc_df$hospdis_loc) <- "Hospital discharge location"

html(
  summaryM(
    as.formula(paste(paste(inhosp_vars, collapse = "+"), "trt", sep = " ~ ")),
    data = inhosp_desc_df,
    overall = TRUE
  ),
  exclude1 = FALSE, long = TRUE, digits = 2, what = "%", npct = "both",
  prmsd = TRUE, brmsd = TRUE, msdsize = mu$smaller2,
  middle.bold = TRUE, outer.size = mu$smaller2, rowsep = TRUE,
  caption = "Description of Intervention Period among Randomized Patients"
)

```

# Description of the Intervention

<hr>

Once randomized, patients could receive study drug for treatment of delirium for up to 14 days, up to twice per day (with a third dose in rare cases). Study drug could be held temporarily, either for delirium resolution or for other reasons, or permanently discontinued. `r table_nums("intervention_pt", display = "cite")` describes randomization, receipt of study drug, reasons for study drug hold or discontinuation, and status at the end of hospitalization for each of the three treatment groups. `r table_nums("intervention_dose", display = "cite")` describes all opportunities to receive study drug dose.

In both tables, quantities are represented as either `N (%)` or as `median [25th, 75th percentiles]`, followed by `mean +/- standard deviation`.

**Note** that temporary holds and permanent discontinuations listed below only include drug stopped for adverse clinical reasons; they do *not* include instances where study drug was not administered due to resolution of delirium or patient unavailability (including ICU discharge, death, study withdrawal, being off the floor, or being placed on comfort care measures/hospice).

## Intervention by Patient

`[PLACEHOLDER TEXT TILL WE GET REAL TREATMENT GROUPS, ASSUMING TREATMENT MEANS NOTHING]`

Patients were approximately equally randomized to the three treatment groups, with each group receiving study drug approximately the same number of days and times. Rates of temporary hold and permanent discontinuation were equivalent among all treatment groups.

Among patients with study drug temporarily held, the most common reasons were oversedation and "other." Study drug was most often discontinued by request of the patient, family, or medical team.

```{r prep_rand_table}
randtable_df <- rand_df %>%
  left_join(
    dplyr::select(ptstatus_df, id, randomized, died_inhosp, wd_inhosp, elig_fu),
    by = "id"
  ) %>%
  ## Add study drug info
  left_join(ptdrug_df, by = "id") %>%
  group_by(trt)

## Summarize variables that just need sums
rand_sums <- randtable_df %>%
  summarise_at(
    vars(randomized, ever_studydrug, ever_drug_held,
         matches("^ever\\_held\\_[a-z]+$"),
         ever_drug_permdc, matches("^permdc\\_[a-z]+$"),
         died_inhosp, wd_inhosp, elig_fu),
    funs(sum_na)
  )

## Summarize continuous variables
rand_cont <- randtable_df %>%
  summarise_at(
    vars(hrs_random_drug, num_drug_days, num_drug_doses, mean_drug_daily),
    funs(q25, q50, q75, "mean" = mean_na, "sd" = sd_na)
  )

## Recombine
rand_table <- left_join(rand_sums, rand_cont, by = "trt") %>%
  ## Calculate and create strings for table
  mutate(
    npct_studydrug = get_npct(ever_studydrug, randomized),
    npct_held = get_npct(ever_drug_held, ever_studydrug),
    npct_held_ae = get_npct(ever_held_ae, ever_drug_held),
    npct_held_dystonia = get_npct(ever_held_dystonia, ever_drug_held),
    npct_held_eps = get_npct(ever_held_eps, ever_drug_held),
    npct_held_other = get_npct(ever_held_other, ever_drug_held),
    npct_held_oversed = get_npct(ever_held_oversed, ever_drug_held),
    npct_held_refuseptfam = get_npct(ever_held_refuseptfam, ever_drug_held),
    npct_held_qtc = get_npct(ever_held_qtc, ever_drug_held),
    npct_held_refuseteam = get_npct(ever_held_refuseteam, ever_drug_held),
    npct_permdc = get_npct(ever_drug_permdc, ever_studydrug),
    npct_permdc_ae = get_npct(permdc_ae, ever_drug_permdc),
    npct_permdc_coma = get_npct(permdc_coma, ever_drug_permdc),
    npct_permdc_refuseteam = get_npct(permdc_refuseteam, ever_drug_permdc),
    npct_permdc_nms = get_npct(permdc_nms, ever_drug_permdc),
    npct_permdc_react = get_npct(permdc_react, ever_drug_permdc),
    npct_permdc_other = get_npct(permdc_other, ever_drug_permdc),
    npct_permdc_refuseptfam = get_npct(permdc_refuseptfam, ever_drug_permdc),
    npct_permdc_torsades = get_npct(permdc_torsades, ever_drug_permdc),
    npct_died = get_npct(died_inhosp, randomized),
    npct_wd = get_npct(wd_inhosp, randomized),
    npct_elig = get_npct(elig_fu, randomized),

    hrs_random_drug = describe_cont(
      hrs_random_drug_q50, hrs_random_drug_q25, hrs_random_drug_q75,
      hrs_random_drug_mean, hrs_random_drug_sd
    ),
    drug_days = describe_cont(
      num_drug_days_q50, num_drug_days_q25, num_drug_days_q75,
      num_drug_days_mean, num_drug_days_sd
    ),
    drug_doses = describe_cont(
      num_drug_doses_q50, num_drug_doses_q25, num_drug_doses_q75,
      num_drug_doses_mean, num_drug_doses_sd
    ),
    mean_drug_daily = describe_cont(
      mean_drug_daily_q50, mean_drug_daily_q25, mean_drug_daily_q75,
      mean_drug_daily_mean, mean_drug_daily_sd
    )
  ) %>%
  dplyr::select(
    trt, randomized, npct_studydrug, hrs_random_drug, drug_days, drug_doses,
    mean_drug_daily, npct_held, matches("^npct\\_held\\_"), npct_permdc,
    matches("^npct\\_permdc\\_"), npct_died, npct_wd, npct_elig
  ) %>%
  gather(key = table_row, value = table_string, -trt) %>%
  spread(key = trt, value = table_string) %>%
  mutate(
    sort_order = case_when(
      table_row == "randomized" ~ 1,
      table_row == "npct_studydrug" ~ 2,
      table_row == "hrs_random_drug" ~ 3,
      table_row == "drug_days" ~ 4,
      table_row == "drug_doses" ~ 5,
      table_row == "mean_drug_daily" ~ 6,
      table_row == "npct_held" ~ 7,
      table_row == "npct_permdc" ~ 8,
      table_row == "npct_died" ~ 9,
      table_row == "npct_wd" ~ 10,
      table_row == "npct_elig" ~ 11,
      str_detect(table_row, "^npct\\_held\\_") ~ 12,
      str_detect(table_row, "^npct\\_permdc\\_") ~ 13,
      TRUE ~ 14),
    table_row = case_when(
      table_row == "randomized"              ~ "Randomized",
      table_row == "npct_studydrug"          ~ "Received >=1 dose study drug",
      table_row == "hrs_random_drug"         ~ "Hours between randomization and first dose given",
      table_row == "drug_days"               ~ "Days received study drug",
      table_row == "drug_doses"              ~ "Doses of study drug",
      table_row == "mean_drug_daily"         ~ "Mean daily dose of study drug (mL)",
      table_row == "npct_held"               ~ "Ever had study drug temporarily held",
      table_row == "npct_permdc"             ~ "Had study drug permanently discontinued",
      table_row == "npct_died"               ~ "Died in the hospital",
      table_row == "npct_wd"                 ~ "Withdrew from study in the hospital",
      table_row == "npct_elig"               ~ "Eligible for long-term follow-up",
      table_row == "npct_held_ae"            ~ "Adverse event",
      table_row == "npct_held_dystonia"      ~ "Dystonia",
      table_row == "npct_held_eps"           ~ "Extrapyramidal symptoms",
      table_row == "npct_held_other"         ~ "Other reason",
      table_row == "npct_held_oversed"       ~ "Oversedation",
      table_row == "npct_held_qtc"           ~ "Prolonged QTc",
      table_row == "npct_held_refuseptfam"   ~ "Patient/family refusal",
      table_row == "npct_held_refuseteam"    ~ "Medical team refusal",
      table_row == "npct_permdc_ae"          ~ "Adverse event",
      table_row == "npct_permdc_coma"        ~ "Coma due to structural brain damage",
      table_row == "npct_permdc_nms"         ~ "NMS",
      table_row == "npct_permdc_other"       ~ "Other reason",
      table_row == "npct_permdc_react"       ~ "DRESS",
      table_row == "npct_permdc_refuseptfam" ~ "Patient/family refusal",
      table_row == "npct_permdc_refuseteam"  ~ "Medical team refusal",
      table_row == "npct_permdc_torsades"    ~ "Torsades de pointes",
      TRUE ~ "")
  ) %>%
  arrange(sort_order) %>%
  dplyr::select(-sort_order)

```

```{r print_rand_table}
rand_table %>%
  kable(
    format = "html",
    col.names = c("", LETTERS[1:3]),
    align = c("l", rep("r", 3))
  ) %>%
  mykablestyle %>%
  group_rows("Randomized Patients", 2, 10) %>%
  group_rows("Reasons Study Drug Temporarily Held", 11, 18) %>%
  group_rows("Reasons Study Drug Permanently Discontinued", 19, 27)

```

## Intervention by Dose

`r table_nums("intervention_dose", display = "cite")` describes the `r format(nrow(doses_df), big.mark = ",")` doses of study drug attempted during the
course of the study, generally two doses per day that the patient remained alive
and in the ICU. This includes doses where drug was held, temporarily or
permanently. Study staff continued to document dose opportunities after
permanent discontinuation; therefore, patients could have >1 dose in that category in this table.

`[PLACEHOLDER TEXT TILL WE GET REAL TREATMENT GROUPS, ASSUMING TREATMENT MEANS NOTHING]`

About 75% of doses were successfully given in each of the three treatment groups, with rates of study drug hold and discontinuation approximately equal between groups. Pre-dose QTcs were also roughly equivalent between the three groups.

Oversedation was the most common reason for temporary hold by far; actual RASSes at the time of dose administration are listed in `r table_nums("intervention_dose", display = "cite")`. Refusal (patient, family, or medical team) was the most common reason for permanent discontinuation.

Though study drug was held or discontinued due to suspected NMS, there were no *confirmed* cases after investigation by the DSMB.

```{r prep_dose_table}
## How many total doses in each treatment group?
doses_grp <- doses_df %>%
  ## Restrict to randomized patients and add treatment group
  right_join(rand_df, by = "id") %>%
  ## Only keep doses either given, or held/d/c'd due to adverse clinical reasons
  ## (excludes doses held due to patient unavailability)
  filter(drug_given | drug_held | drug_permdc) %>%
  group_by(trt) %>%
  summarise(doses_trt = n())

## Summarize variables that just need sums
dose_table <- doses_df %>%
  ## Restrict to randomized patients and add treatment group
  right_join(rand_df, by = "id") %>%
  ## Only keep doses either given, or held/d/c'd due to adverse clinical reasons
  ## (excludes doses held due to patient unavailability)
  filter(drug_given | drug_held | drug_permdc) %>%
  group_by(trt) %>%
  summarise(
    doses_given = sum_na(drug_given),
    doses_held = sum_na(drug_held),
    doses_permdc = sum_na(drug_permdc),
    type_initial = sum_na(dose_type == "Initial Starting Dose"),
    type_restart = sum_na(dose_type == "Restarting Dose"),
    type_increase = sum_na(dose_type == "Increased Dose"),
    type_decrease = sum_na(dose_type == "Decreased Dose (CAM-ICU Negative)"),
    type_maintmax = sum_na(dose_type == "Maintained at Maximum Dose"),
    type_maint = sum_na(
      dose_type == "Maintained (at current dose for medically induced coma)"
    ),
    type_other = sum_na(dose_type == "Other"),
    amt_025 = sum_na(dose_amt == 0.25),
    amt_050 = sum_na(dose_amt == 0.50),
    amt_100 = sum_na(dose_amt == 1.00),
    amt_200 = sum_na(dose_amt == 2.00),
    q25_preqtc = q25(pre_dose_qtc),
    q50_preqtc = q50(pre_dose_qtc),
    q75_preqtc = q75(pre_dose_qtc),
    mean_preqtc = mean_na(pre_dose_qtc),
    sd_preqtc = sd_na(pre_dose_qtc),
    held_qtc = sum_na(held_qtc),
    held_oversed = sum_na(held_oversed),
    rass_0 = sum_na(oversed_actual == "0"),
    rass_1 = sum_na(oversed_actual == "-1"),
    rass_2 = sum_na(oversed_actual == "-2"),
    rass_3 = sum_na(oversed_actual == "-3"),
    rass_4 = sum_na(oversed_actual == "-4"),
    rass_5 = sum_na(oversed_actual == "-5"),
    held_eps = sum_na(held_eps),
    held_dystonia = sum_na(held_dystonia),
    held_ae = sum_na(held_ae),
    held_refuseteam = sum_na(held_refuseteam),
    held_refuseptfam = sum_na(held_refuseptfam),
    held_other = sum_na(held_other),
    permdc_nms = sum_na(permdc_nms),
    permdc_react = sum_na(permdc_react),
    permdc_torsades = sum_na(permdc_torsades),
    permdc_coma = sum_na(permdc_coma),
    permdc_ae = sum_na(permdc_ae),
    permdc_refuseptfam = sum_na(permdc_refuseptfam),
    permdc_refuseteam = sum_na(permdc_refuseteam),
    permdc_other = sum_na(permdc_other)
  ) %>%
  ## Add total doses per treatment group; need these for denominators
  left_join(doses_grp, by = "trt") %>%
  ## -- Turn into a table ------------------------------------------------------
  ## Doses given
  mutate_at(
    vars(type_initial:amt_200), funs(get_npct(., denom = doses_given))
  ) %>%
  mutate(
    desc_preqtc = describe_cont(
      q50_preqtc, q25_preqtc, q75_preqtc, mean_preqtc, sd_preqtc
    )
  ) %>%
  ## Doses temporarily held
  mutate_at(vars(rass_0:rass_5), funs(get_npct(., denom = held_oversed))) %>%
  mutate_at(
    vars(held_qtc, held_oversed, held_eps:held_other),
    funs(get_npct(., denom = doses_held))
  ) %>%
  ## Doses permanently discontinued
  mutate_at(
    vars(permdc_nms:permdc_other), funs(get_npct(., denom = doses_permdc))
  ) %>%
  ## Do these last because we need the numeric versions for numerators
  mutate_at(
    vars(doses_given, doses_held, doses_permdc),
    funs(get_npct(., denom = doses_trt))
  ) %>%
  ## Transpose to one row per descriptor, with a column for each treatment group
  dplyr::select(trt, doses_trt, doses_given:doses_permdc, type_initial:amt_200,
         desc_preqtc, held_qtc:held_other, rass_0:rass_5,
         permdc_nms:permdc_other) %>%
  gather(key = table_row, value = dose_value, -trt) %>%
  spread(key = trt, value = dose_value) %>%
  ## Table formatting
  mutate(
    sort_order = case_when(
      table_row == "doses_trt" ~ 1,
      table_row == "doses_given" ~ 2,
      table_row == "doses_held" ~ 3,
      table_row == "doses_permdc" ~ 4,
      table_row == "amt_025" ~ 5,
      table_row == "amt_050" ~ 6,
      table_row == "amt_100" ~ 7,
      table_row == "amt_200" ~ 8,
      table_row == "type_initial" ~ 9,
      table_row == "type_restart" ~ 10,
      table_row == "type_decrease" ~ 11,
      table_row == "type_increase" ~ 12,
      table_row == "type_maint" ~ 13,
      table_row == "type_maintmax" ~ 14,
      table_row == "type_other" ~ 15,
      table_row == "desc_preqtc" ~ 16,
      table_row == "held_ae" ~ 17,
      table_row == "held_dystonia" ~ 18,
      table_row == "held_eps" ~ 19,
      table_row == "held_oversed" ~ 20,
      table_row == "held_qtc" ~ 21,
      table_row == "held_refuseptfam" ~ 22,
      table_row == "held_refuseteam" ~ 23,
      table_row == "held_other" ~ 24,
      table_row %in% paste0("rass_", 0:5) ~ 25,
      table_row == "permdc_ae" ~ 26,
      table_row == "permdc_coma" ~ 27,
      table_row == "permdc_nms" ~ 28,
      table_row == "permdc_react" ~ 29,
      table_row == "permdc_torsades" ~ 30,
      table_row == "permdc_refuseptfam" ~ 31,
      table_row == "permdc_refuseteam" ~ 32,
      table_row == "permdc_other" ~ 33,
      TRUE ~ 34
    ),
    table_row = case_when(
      table_row == "doses_trt" ~ "Dose Opportunities",
      table_row == "doses_given" ~ "Given",
      table_row == "doses_held" ~ "Temporarily held",
      table_row == "doses_permdc" ~ "Permanently discontinued",
      table_row == "amt_025" ~ "0.25 mL",
      table_row == "amt_050" ~ "0.50 mL",
      table_row == "amt_100" ~ "1.00 mL",
      table_row == "amt_200" ~ "2.00 mL",
      table_row == "type_initial" ~ "Initial starting dose",
      table_row == "type_restart" ~ "Restarting dose",
      table_row == "type_decrease" ~ "Decrease (CAM-ICU negative)",
      table_row == "type_increase" ~ "Increase",
      table_row == "type_maint" ~ "Maintained (med. induced coma)",
      table_row == "type_maintmax" ~ "Maintained at max dose",
      table_row == "type_other" ~ "Other",
      table_row == "desc_preqtc" ~ "Pre-dose QTc",
      table_row == "held_ae" ~ "Adverse event",
      table_row == "held_dystonia" ~ "Dystonia",
      table_row == "held_eps" ~ "Extrapyramidal symptoms",
      table_row == "held_oversed" ~ "Oversedation",
      table_row == "held_qtc" ~ "Prolonged QTc",
      table_row == "held_refuseptfam" ~ "Patient/family refusal",
      table_row == "held_refuseteam" ~ "Medical team refusal",
      table_row == "held_other" ~ "Other",
      table_row == "rass_0" ~ "0",
      table_row %in% paste0("rass_", 1:5) ~
        paste0("-", gsub("^rass\\_", "", table_row)),
      table_row == "permdc_ae" ~ "Adverse event",
      table_row == "permdc_coma" ~ "Coma due to structural brain damage",
      table_row == "permdc_nms" ~ "Suspected NMS",
      table_row == "permdc_react" ~ "DRESS",
      table_row == "permdc_torsades" ~ "Suspected Torsades de pointes",
      table_row == "permdc_refuseptfam" ~ "Patient/family refusal",
      table_row == "permdc_refuseteam" ~ "Medical team refusal",
      table_row == "permdc_other" ~ "Other",
      TRUE ~ "fix this!"
    )
  ) %>%
  arrange(sort_order) %>%
  dplyr::select(-sort_order)

```

```{r print_dose_table}
dose_table %>%
  kable(
    format = "html",
    col.names = c("", LETTERS[1:3]),
    align = c("l", rep("r", 3))
  ) %>%
  mykablestyle %>%
  group_rows("All Dose Opportunities", 2, 4) %>%
  group_rows("Doses Given", 5, 16) %>%
  group_rows("Doses Temporarily Held", 17, 24) %>%
  group_rows("Actual RASS for Doses Held due to Oversedation", 25, 30) %>%
  group_rows("Doses Permanently Discontinued", 31, 38)

```

## "Other" Reasons for Hold & Discontinuation

Explanations for study drug held (`r table_nums("dose_held_other", display = "cite")`) and discontinued (`r table_nums("dose_permdc_other", display = "cite")`) for "other" reasons are listed in the tables below. To save space, these tables are collapsed; click on `Details` to see them. (These explanations are taken directly from our database; potentially identifiable information,
including dates, times and parenthetical details, have been redacted to preserve
patient privacy.)

```{r prep_dose_other}
other_held_table <- doses_df %>%
  filter(held_other) %>%
  dplyr::select(held_other_exp)

other_permdc_table <- doses_df %>%
  filter(permdc_other) %>%
  dplyr::select(permdc_other_exp)

```

##### `r table_nums("dose_held_other")`

<details>
<summary>"Other" Reasons Study Drug Held</summary>
```{r print_dose_held_other}
other_held_table %>%
  kable(
    format = "html",
    col.names = c("Explanation for 'other' study drug hold"),
    align = c("l")
  ) %>%
  mykablestyle(stripes = TRUE)

```
</details>

##### `r table_nums("dose_permdc_other")`

<details>
<summary>"Other" Reasons Study Drug Permanently Discontinued</summary>
```{r print_dose_permdc_other}
other_permdc_table %>%
  kable(
    format = "html",
    col.names = c("Explanation for 'other' study drug discontinuation"),
    align = c("l")
  ) %>%
  mykablestyle(stripes = TRUE)

```
</details>

## Protocol Noncompliance

We summarize below any protocol noncompliance that increased safety risk to the patient, broken down according to a simple categorization scheme followed prospectively during the conduct of the MIND-USA investigation. During the entire study, there were `r nrow(noncompliance_df)` events which met these criteria, among `r length(unique(noncompliance_df$id))` unique patients.

```{r noncompliance}
## -- Summarize protocol noncompliance: N (%) in each category -----------------
## Variables indicating categories for noncompliance
noncomp_cats <- str_subset(names(noncompliance_df), "^ntf\\_cat\\_")

## How many noncompliance events in each treatment group?
noncomp_trt <- c(
  map_int(levels(rand_df$trt), ~ sum_na(noncompliance_df$trt == .) ),
  sum(is.na(noncompliance_df$trt))
) %>%
  set_names(c(levels(rand_df$trt), "Not randomized"))

## Create final data frame with N, % of each noncompliance category
noncomp_npct <- noncompliance_df %>%
  mutate(trt = ifelse(is.na(trt), "Not randomized", as.character(trt))) %>%
  group_by(trt) %>%
  summarise_at(vars(noncomp_cats), sum_na) %>%
  ungroup() %>%
  gather(key = ntf_cat, value = cat_n, -trt) %>%
  spread(key = trt, value = cat_n) %>%
  mutate(Overall = rowSums(.[, 2:ncol(.)])) %>%
  ## Sort in order of overall total
  arrange(desc(Overall)) %>%
  ## Get percentages for each column in a hack-y sort of way; I really want
  ## modify2 to exist but it does not
  mutate(
    Haloperidol =
      get_npct(num = Haloperidol, denom = pluck(noncomp_trt, "Haloperidol")),
    Ziprasidone =
      get_npct(num = Ziprasidone, denom = pluck(noncomp_trt, "Ziprasidone")),
    Placebo = get_npct(num = Placebo, denom = pluck(noncomp_trt, "Placebo")),
    `Not randomized` = get_npct(
      num = `Not randomized`, denom = pluck(noncomp_trt, "Not randomized")
    ),
    Overall = get_npct(num = Overall, denom = nrow(noncompliance_df)),
    ntf_cat = case_when(
      ntf_cat == "ntf_cat_other" ~ "Other category",
      ntf_cat == "ntf_cat_asmt" ~
        "Study assessment not completed, not documented",
      ntf_cat == "ntf_cat_titration" ~ "Study drug titration not as outlined",
      ntf_cat == "ntf_cat_specimen" ~
        "Blood specimens not collected as outlined",
      ntf_cat == "ntf_cat_incexc" ~ "Inclusion/exclusion criteria violation",
      ntf_cat == "ntf_cat_saeirb" ~ "SAE not reported appropriately to VCC",
      ntf_cat == "ntf_cat_saevcc" ~ "SAE not reported appropriately to IRB",
      TRUE ~ "[missing]"
    )
  ) %>%
  dplyr::select(
    ntf_cat, Haloperidol, Ziprasidone, Placebo, `Not randomized`, Overall
  )

```

```{r noncompliance_summary}
noncomp_npct %>%
  kable(
    format = "html",
    col.names = c(
      "Category of noncompliance",
      "Haloperidol", "Ziprasidone", "Placebo",
      "Not Randomized", "All Events"
    ),
    align = c("l", rep("r", 5))
  ) %>%
  mykablestyle()

```

For full transparency, we also include in the searchable table below details on
each incidence of protocol noncompliance which increased patient risk. PHI in
NTF explanations has been redacted.

```{r noncompliance_all}
## Helper function to replace TRUE with given string, FALSE with ""
replace_true <- function(x, rep_str){ ifelse(x, rep_str, "") }

noncomp_details <- noncompliance_df %>%
  ## Replace T/F indicators for individual categories with text strings, then
  ## combine into a single column for easier printing
  mutate(
    ntf_cat_incexc =
      replace_true(ntf_cat_incexc, "Inclusion/exclusion criteria"),
    ntf_cat_specimen = replace_true(ntf_cat_specimen, "Specimen collection"),
    ntf_cat_titration = replace_true(ntf_cat_titration, "Study drug titration"),
    ntf_cat_asmt = replace_true(ntf_cat_asmt, "Assessment not done/documented"),
    ntf_cat_saevcc = replace_true(ntf_cat_saevcc, "SAE reporting, VCC"),
    ntf_cat_saeirb = replace_true(ntf_cat_saeirb, "SAE reporting, IRB"),
    ntf_cat_other = replace_true(ntf_cat_other, "Other category")
  ) %>%
  unite(col = ntf_categories, noncomp_cats, sep = "; ") %>%
  mutate(ntf_categories = str_replace_all(ntf_categories, "(; )+", "; ") %>%
           str_remove_all("^; ") %>% str_remove_all("; $")) %>%
  dplyr::select(id, trt, ntf_categories, ntf_explain) %>%
  DT::datatable(
    colnames = c("ID", "Treatment", "Noncompliance Categories", "Explanation"),
    filter = "top",
    options = list(
      pageLength = 2,
      lengthMenu = c(2, 5, 10, 15, 20)
    )
  )

```

# Safety Outcomes and ABCDE Bundle Compliance

Our three primary safety outcomes are neuroleptic malignant syndrome (NMS); Torsades de pointes (Torsades); and extrapyramidal symptoms (EPS). Incidence of each was minimal and is detailed below.

We also collected data on daily performance of some elements of the [ABCDEF Bundle](http://www.iculiberation.org/Bundles/Pages/default.aspx); we describe
compliance with these elements on a daily basis, both for all patient-days and
for randomized patients during the intervention.

### NMS

All suspected cases of NMS (i.e., patients in whom there was an initial suspicion of possible NMS) were rapidly reported to the DSMB for evaluation and
the final determination of existence. No randomized patients ever experienced
*confirmed* NMS during the study (during or outside the intervention phase).

```{r nms}
## How many patients experienced NMS at all? during intervention?
n_rand_nms_ih <- sum_na(ptsummary_df$ever_nms_ih)
n_rand_nms_int <- sum_na(ptsummary_df$ever_nms_int)

## In an ideal, reproducible world, we'd code text to account for all plausible
## scenarios, but we have a deadline and both the above are zero so we're just
## going to go with that because that data will not change at this point.

```

### Torsades de Pointes

All suspected cases of Torsades de pointes were rapidly reported to the DSMB for
the final determination of existence.

During the intervention phase, `r sum_na(ptsummary_df$ever_torsades_any_int)` randomized patients experienced confirmed Torsades de pointes. Both instances
were recorded as adverse events in the category of "Torsades, clinical outcome";
descriptions of both events are included below, with potentially identifying
details redacted.

```{r torsades}
torsades_df %>%
  dplyr::select(-ae_serious) %>% ## Torsades always serious, redundant
  kable(
    format = "html",
    col.names = c("ID", "Trt", "Study Phase", "Description")
  ) %>%
  mykablestyle()

```

### EPS

To describe and determine the presence of extrapyramidal symptoms (EPS), we used a modified version of the [Simpson-Angus Score](http://onlinelibrary.wiley.com/doi/10.1111/j.1600-0447.1970.tb02066.x/epdf) which included elbow and wrist rigidity, glabellar tap, resting tremor, and salivation. Study drug was held if at least three out of these five symptoms had a score of 3 or higher on a given day; patients whose glabellar tap reflex could not be assessed were assigned a symptom score of 0. (Study drug was restarted if EPS resolved to a score of <3 on all categories.) Details for the `r sum_na(ptsummary_df$ever_eps_int)` randomized patients who met this criteria at least once during the intervention period are shown below.

```{r eps}
ptsummary_df %>%
  filter(ever_eps_int) %>%
  dplyr::select(
    id, trt, days_eps_int, eps_score_mean_exp_int, ever_held_eps, times_held_eps
  ) %>%
  kable(
    format = "html",
    col.names = c(
      "ID", "Trt", "Days met EPS criteria",
      "Overall EPS Score when Criteria Met",
      "Study drug held for EPS?", "Doses held for EPS"
    )
  ) %>%
  mykablestyle()

```

### ABCDE Compliance

We collected data on the following elements related to the [ABCDEF Bundle](http://www.iculiberation.org/Bundles/Pages/default.aspx), using the earlier definitions of "compliance" in place when study enrollment began. **In
order to be eligible for any of these on a given day, the patient had to have
been in the ICU all 24 hours.**

- *Awakening* (SAT)
    - Eligible if: On mechanical ventilation, and not off unit when staff
    attempted SAT
    - Compliant if: Received an SAT, or did not receive an SAT for a reason
    besides "other"
- *Breathing* (SBT)
    - Eligible if: On mechanical ventilation, and not off unit when staff
    attempted SBT
    - Compliant if: Received an SBT, or did not receive an SBT for a reason
    besides "other"
- *Coordination* (Coordination of SAT and SBT)
    - Eligible if: On invasive MV and received both an SAT and SBT
    - Compliant if: Patient was off sedation when SBT was performed
- Nonpharmacological interventions for *delirium*
    - Eligible if: Not comatose
    - Compliant if: Received >=1 nonpharmacological intervention (pain
    assessment/management, orientation, sensory, sleep)
- *Early mobility/exercise*
    - Eligible if: Not off floor when staff attempted therapy
    - Compliant if: Was screened for safety, and either:
        - Failed safety screen for a recorded reason (MI, arrhythmia, FiO2,
        PEEP, or vasopressors)
        - Passed safety screen, but did not receive mobility due to
        sedatives/analgesics or refusal of patient, family, or clinical team
        - Received mobility
        
```{r abcde_table}
## -- One set of cols for all patient-days; one for all intervention days ------

## Wrapper function to combine results for intervention only, all patient-days
combine_abcde <- function(comp_fn){
  df_int <- do.call(comp_fn, list(daily_int_df %>% filter(intervention)))
  df_all <- do.call(comp_fn, list(daily_all_df))
  
  left_join(df_int, df_all, by = "Variable") %>%
    set_names(c("Variable", "Intervention Period", "All Patient-Days"))
}

## Awakening
get_comp_a <- function(df){
  days_elig <- sum_na(df$elig_a)
  days_comp <- sum_na(df$comp_a)
  days_sat <- sum_na(subset(df, comp_a)$sat_today)
  days_nosat <- sum_na(!subset(df, comp_a)$sat_today)
  days_sat_why <- map_int(
    str_subset(names(df), "^sat\\_rsn\\_"),
    ~ sum_na(pluck(subset(df, comp_a), .))
  ) %>%
    set_names(
      str_remove(str_subset(names(df), "^sat\\_rsn\\_"), "^sat\\_rsn\\_")
    )
  
  df_a <- tribble(
    ~ Variable,            ~ Days,                            ~ Denom,
    "Days Eligible",       days_elig,                         nrow(df),
    "Days Compliant",      days_comp,                         days_elig,
    "Had SAT",             days_sat,                          days_comp,
    "No SAT",              days_nosat,                        days_comp,
    "Seizures",            pluck(days_sat_why, "seizures"),   days_nosat,
    "Alcohol withdrawal",  pluck(days_sat_why, "alcohol"),    days_nosat,
    "Agitation",           pluck(days_sat_why, "agitation"),  days_nosat,
    "Paralytics",          pluck(days_sat_why, "paralytics"), days_nosat,
    "Myocardial ischemia", pluck(days_sat_why, "mi"),         days_nosat,
    "High ICP",            pluck(days_sat_why, "icp"),        days_nosat
  ) %>%
    mutate(
      Pct = get_npct(Days, Denom),
      sort_var = case_when(
        Variable == "Days Eligible" ~ 1,
        Variable == "Days Compliant" ~ 2,
        Variable == "Had SAT" ~ 3,
        Variable == "No SAT" ~ 4,
        TRUE ~ 5
      )
    ) %>%
    arrange(sort_var, desc(Days)) %>%
    dplyr::select(Variable, Pct)
  
  return(df_a)
}

## Breathing
get_comp_b <- function(df){
  days_elig <- sum_na(df$elig_b)
  days_comp <- sum_na(df$comp_b)
  days_sbt <- sum_na(subset(df, comp_b)$sbt_today)
  days_nosbt <- sum_na(!subset(df, comp_b)$sbt_today)
  days_sbt_why <- map_int(
    str_subset(names(df), "^sbt\\_rsn\\_"),
    ~ sum_na(pluck(subset(df, comp_b), .))
  ) %>%
    set_names(
      str_remove(str_subset(names(df), "^sbt\\_rsn\\_"), "^sbt\\_rsn\\_")
    )
  
  df_b <- tribble(
    ~ Variable,                    ~ Days,                           ~ Denom,
    "Days Eligible",               days_elig,                        nrow(df),
    "Days Compliant",              days_comp,                        days_elig,
    "Had SBT",                     days_sbt,                         days_comp,
    "No SBT",                      days_nosbt,                       days_comp,
    "Agitation",                   pluck(days_sbt_why, "agitation"), days_nosbt,
    "O2 sat <88%",                 pluck(days_sbt_why, "o2sat"),     days_nosbt,
    "FiO2 >50%",                   pluck(days_sbt_why, "fio2"),      days_nosbt,
    "PEEP >7.5cm H2O",             pluck(days_sbt_why, "peep"),      days_nosbt,
    "Myocardial ischemia",         pluck(days_sbt_why, "mi"),        days_nosbt,
    "Significant vasopressor use", pluck(days_sbt_why, "vasopressor"),        days_nosbt,
    "APRV/BiVent & P1 >24",        pluck(days_sbt_why, "aprv"),      days_nosbt
  ) %>%
    mutate(
      Pct = get_npct(Days, Denom),
      sort_var = case_when(
        Variable == "Days Eligible" ~ 1,
        Variable == "Days Compliant" ~ 2,
        Variable == "Had SBT" ~ 3,
        Variable == "No SBT" ~ 4,
        TRUE ~ 5
      )
    ) %>%
    arrange(sort_var, desc(Days)) %>%
    dplyr::select(Variable, Pct)
  
  return(df_b)
}

## Coordination
get_comp_c <- function(df){
  days_elig <- sum_na(df$elig_c)
  days_comp <- sum_na(df$comp_c)

  df_c <- tribble(
    ~ Variable,       ~ Days,    ~ Denom,
    "Days Eligible",  days_elig, nrow(df),
    "Days Compliant", days_comp, days_elig
  ) %>%
    mutate(
      Pct = get_npct(Days, Denom),
      sort_var = case_when(
        Variable == "Days Eligible" ~ 1,
        Variable == "Days Compliant" ~ 2,
        TRUE ~ 5
      )
    ) %>%
    arrange(sort_var, desc(Days)) %>%
    dplyr::select(Variable, Pct)
  
  return(df_c)
}

## Delirium
get_comp_d <- function(df){
  days_elig <- sum_na(df$elig_d)
  days_comp <- sum_na(df$comp_d)
  days_int_num <- map_int(
    1:4, ~ sum_na(subset(df, comp_d)$nonpharm_int == .)
  ) %>%
    set_names(1:4)
  days_int_each <- map_int(
    str_subset(names(df), "^nonpharm\\_int\\_"),
    ~ sum_na(pluck(subset(df, comp_d), .))
  ) %>%
    set_names(
      str_remove(
        str_subset(names(df), "^nonpharm\\_int\\_"),
        "^nonpharm\\_int\\_"
      )
    )

  df_d <- tribble(
    ~ Variable,                   ~ Days,                          ~ Denom,
    "Days Eligible",              days_elig,                       nrow(df),
    "Days Compliant",             days_comp,                       days_elig,
    "One intervention",           pluck(days_int_num, "1"),        days_comp,
    "Two interventions",          pluck(days_int_num, "2"),        days_comp,
    "Three interventions",        pluck(days_int_num, "3"),        days_comp,
    "Four interventions",         pluck(days_int_num, "4"),        days_comp,
    "Pain assessment/management", pluck(days_int_each, "pain"),    days_comp,
    "Orientation",                pluck(days_int_each, "orient"),  days_comp,
    "Sensory",                    pluck(days_int_each, "sensory"), days_comp,
    "Sleep",                      pluck(days_int_each, "sleep"),   days_comp
  ) %>%
    mutate(
      Pct = get_npct(Days, Denom),
      sort_var = case_when(
        Variable == "Days Eligible" ~ 1,
        Variable == "Days Compliant" ~ 2,
        Variable == "One intervention" ~ 3,
        Variable == "Two interventions" ~ 4,
        Variable == "Three interventions" ~ 5,
        Variable == "Four interventions" ~ 6,
        TRUE ~ 7
      )
    ) %>%
    arrange(sort_var, desc(Days)) %>%
    dplyr::select(Variable, Pct)
  
  return(df_d)
}

## Delirium
get_comp_e <- function(df){
  days_elig <- sum_na(df$elig_e)
  days_comp <- sum_na(df$comp_e)
  days_mobility_each <- map_int(
    levels(df$mobility_highest),
    ~ sum_na(subset(df, comp_e)$mobility_highest == .)
  ) %>%
    set_names(str_remove(levels(df$mobility_highest), " \\(.*$"))

  df_e <- tribble(
    ~ Variable,                   ~ Days,                            ~ Denom,
    "Days Eligible",              days_elig,                         nrow(df),
    "Days Compliant",             days_comp,                         days_elig,
    "L1 (Active ROM/sitting)", pluck(days_mobility_each, "Level 1"), days_comp,
    "L2 (Dangling)",           pluck(days_mobility_each, "Level 2"), days_comp,
    "L3 (Active transfers)",   pluck(days_mobility_each, "Level 3"), days_comp,
    "L4 (Marching/walking)",   pluck(days_mobility_each, "Level 4"), days_comp
  ) %>%
    mutate(
      Pct = get_npct(Days, Denom),
      sort_var = case_when(
        Variable == "Days Eligible" ~ 1,
        Variable == "Days Compliant" ~ 2,
        str_sub(Variable, 1, 2) == "L1" ~ 3,
        str_sub(Variable, 1, 2) == "L2" ~ 4,
        str_sub(Variable, 1, 2) == "L3" ~ 5,
        str_sub(Variable, 1, 2) == "L4" ~ 6,
        TRUE ~ 7
      )
    ) %>%
    arrange(sort_var, desc(Days)) %>%
    dplyr::select(Variable, Pct)
  
  return(df_e)
}

## Iterate over all elements to create final table
abcde_table <- map_df(
  list(get_comp_a, get_comp_b, get_comp_c, get_comp_d, get_comp_e),
  combine_abcde,
  .id = "element"
) %>%
  mutate(
    poptext = case_when(
      Variable == "Days Eligible" & element == "1" ~ "On invasive MV and on unit",
      Variable == "Days Compliant" & element == "1" ~
        "Received SAT, or no SAT for safety reason",
      Variable == "Days Eligible" & element == "2" ~ "On invasive MV and on unit",
      Variable == "Days Compliant" & element == "2" ~ "Received SBT, or no SBT for safety reason",
      Variable == "Days Eligible" & element == "3" ~ "On invasive MV, received SAT+SBT",
      Variable == "Days Compliant" & element == "3" ~ "Off sedation when SBT performed",
      Variable == "Days Eligible" & element == "4" ~ "Not comatose",
      Variable == "Days Compliant" & element == "4" ~ ">=1 nonpharmacological intervention",
      Variable == "Days Eligible" & element == "5" ~ "On unit",
      Variable == "Days Compliant" & element == "5" ~ "Screened and: failed screen; no mobility d/t meds or refusal; or received at least some mobility",
      Variable %in% c("No SAT", "No SBT") ~
        "For reason considered compliant, listed below",
      TRUE ~ ""
    ),
    poppos = "auto"
  )

abcde_table$Variable <- cell_spec(
  abcde_table$Variable,
  popover = spec_popover(
    content = abcde_table$poptext,
    title = NULL,
    position = abcde_table$poppos
  )
)

abcde_table %>%
  dplyr::select(2:4) %>%
  kable(
    escape = FALSE,
    format = "html",
    col.names = c("", "Intervention Period", "All Patient-Days"),
    align = c("l", "r", "r")
  ) %>%
  row_spec(c(1, 2, 11, 12, 22:25, 34, 35), bold = TRUE) %>%
  row_spec(c(5:10, 15:21), color = palette_colors[["lgray"]]) %>%
  group_rows("Awakening", 1, 10) %>%
  group_rows("Breathing", 11, 21) %>%
  group_rows("Coordination", 22, 23) %>%
  group_rows("Delirium", 24, 33) %>%
  group_rows("Early Mobility/Exercise", 34, 39) %>%
  mykablestyle()

```

# Exploration of Missing Data & Potential Redundancy{#exploration}

We examine all outcomes and covariates to determine how much missing data is present. In short, we have no missingness for our outcomes and very little for our covariates; therefore, we will perform complete case analysis only. Expand the `Details` section below for further information.

```{r model_prep}
## -- Create dataset with only outcomes, covariates ----------------------------
outcome_vars <- c(
  "dcfd_int", "del_int_all", "coma_int_all",
  "tte_death_30", "event_death_30",     ## Time to death within 30 days
  "tte_death_90", "event_death_90",     ## Time to death within 90 days
  "tte_icudis_90", "ftype_icudis_90",   ## Time to final, succ. ICU discharge
  "tte_hospdis_90", "ftype_hospdis_90", ## Time to hospital discharge
  "tte_mvlib_30", "ftype_mvlib_30",     ## Time to liberation from MV
  "tte_readm_90", "ftype_readm_90"      ## Time to ICU readmission
)

covariate_vars <- c(
  "age_consent", "charlson_total", "iqcode_total_ph", "frailty",
  "sofa_mod_imp_rand", "trt"
)

model_df <- ptsummary_df %>%
  dplyr::select(
    id, study_site, on_mv_rand24, rass_rand, elig_readm,
    one_of(outcome_vars), one_of(covariate_vars)
  ) %>%
  ## Create category for level of arousal at randomization,
  ##   using RASS closest to time of randomization within 5 hours
  mutate(
    arousal_rand = factor(
      case_when(
        is.na(rass_rand) ~ as.numeric(NA),
        rass_rand %in% c(-3) ~ 1,
        rass_rand %in% c(-2, -1) ~ 2,
        rass_rand %in% c(0) ~ 3,
        TRUE ~ 4
      ),
      levels = 1:4,
      labels = c("Deeply sedated", "Lightly sedated", "Normal", "Agitated")
    )
  )

## Add newly created arousal_rand to covariate_vars
covariate_vars <- c(covariate_vars, "arousal_rand")

## Add indicator for complete covariate data
model_df$comp_covars <- rowSums(is.na(model_df[, covariate_vars])) == 0
## How many randomized patients have complete covariate data?
n_rand_comp <- sum_na(model_df$comp_covars)

## What % of patients are missing at least one covariate/outcome?
## (This does *not* include variables related to liberation from MV or ICU
## readmission, as that would introduce artificial missingness)
pts_missany <- model_df %>%
  dplyr::select(-rass_rand, -on_mv_rand24, -tte_mvlib_30, -ftype_mvlib_30) %>%
  miss_case_table() %>%
  filter(n_miss_in_case > 0) %>%
  summarise(
    nmiss = sum_na(n_cases),
    pctmiss = sum_na(pct_miss)
  )

## Set datadist to this data.frame
dd <- datadist(model_df)
options(datadist = "dd")

## -- Create sparklines to show distributions ----------------------------------
create_spark <- function(
  vname,                                 ## variable name; must be in df
  vbreaks = NULL,                        ## breaks to bin data, if desired
  spark_id = sprintf("spark-%s", vname), ## name of sparkline element
  spark_width = 50,                      ## sparkline width
  df = model_df                          ## data.frame to use
){
  if(is.null(vbreaks)){
    df$vcuts <- df[, vname]
  } else{
    df$vcuts <- cut(df[, vname], breaks = vbreaks)
  }
  
  barhts <- df %>%
    group_by(vcuts) %>%
    summarise(count = n())
  
  sparkline(
    barhts$count,
    type = "bar",
    barColor = as.character(palette_colors["dred"]),
    elementId = spark_id,
    width = spark_width
  )
}

spark_iqcode <- create_spark(
  "iqcode_total_ph",
  vbreaks = seq(0, 5, 0.25),
  spark_id = "spark-iqcode"
)

spark_dcfd <- create_spark(
  "dcfd_int",
  # vbreaks = seq(-1, 14, 1),
  spark_id = "spark-dcfd",
  spark_width = 50
)

spark_del <- create_spark(
  "del_int_all",
  # vbreaks = seq(-1, 14, 1),
  spark_id = "spark-del",
  spark_width = 50
)

spark_coma <- create_spark(
  "coma_int_all",
  # vbreaks = seq(-1, 14, 1),
  spark_id = "spark-coma",
  spark_width = 50
)

## -- Create model RHS for multiple uses ---------------------------------------
## How many knots for continuous covariates? Which ones are continuous?
rcsknots <- 3
cont_covars <- c("age_consent", "charlson_total", "frailty", "sofa_mod_imp_rand")
notcont_covars <- setdiff(covariate_vars, cont_covars)

mod_rhs <- map_chr(cont_covars, ~ sprintf("rcs(%s, %s)", ., rcsknots)) %>%
  c(., notcont_covars) %>%
  paste(collapse = " + ")

## For testing purposes: RHS, no splines
mod_rhs_lin <- paste(covariate_vars, collapse = " + ")

```

<details>
<summary>Summary of Covariate & Outcome Missingness</summary>

```{r missing_allpts}
gg_miss_var(
  model_df %>%
    dplyr::select(
      -id, -rass_rand, -on_mv_rand24, -tte_mvlib_30, -ftype_mvlib_30,
      -tte_readm_90, -ftype_readm_90
    ),
  show_pct = TRUE
) +
  scale_y_continuous(name = "% Missing", limits = c(0, 5)) +
  geom_hline(yintercept = 5, colour = "gray50", linetype = "dotted") +
  labs(
    title = "Outcome and Covariate Missingness for Most Models",
    subtitle = "Includes all randomized patients"
  )

```

IQCODE and level of arousal at randomization are the only covariates with missing data; the amount is still quite minimal (<2%), and these variables are not missing in ways that appear to be related. In the plot below, red indicates missingness and blue indicates a present value. Cases which have both variables missing would be in red in the lower lefthand corner.

```{r iqcode_rass_miss}
ggplot(data = model_df) +
  geom_miss_point(aes(x = iqcode_total_ph, y = rass_rand),
                  position = position_jitter(height = 0.2), alpha = 0.5)

```

</details>

To make sure none of our covariates completely explain any of the others
(resulting in collinearity), we perform a redundancy analysis, detailed below.
No covariates suggest evidence of too-high collinearity.

```{r redundancy, results = "markup"}
Hmisc::redun(
  ~ age_consent + charlson_total + frailty + sofa_mod_imp_rand +
    I(iqcode_total_ph) + arousal_rand + trt,
  data = model_df,
  nk = rcsknots
)

```

# Statistical Methods{#methods}

<hr>

Our full, prespecified Statistical Analysis Plan includes more detailed information on database management, data cleaning, study methods, and guiding statistical principles. [Google doc link, temporary; will change to OSF link once registered](https://docs.google.com/document/d/1BtivVYbGOlNiCtRMoiKvVQAp-_RW7wUhcsDzywWPh-k/edit?ts=5abfef33#heading=h.cup0kvg921mo)

## Unadjusted Analysis{#unadjusted}

### In-Hospital Continuous Outcomes

We analyze continuous outcomes (delirium/coma-free days, delirium duration, and
coma duration) using the Kruskal-Wallis test. These outcomes are not normally
distributed (see each section for further details); therefore, the assumptions
for a parametric ANOVA would be violated, and results would be unreliable. The
nonparametric Kruskal-Wallis test does not assume that the outcome has a
specific distribution, and thus provides more power and reliability in the case
of a non-normal distribution.

### Time to Event Outcomes

We describe and test for differences in time to death using Kaplan-Meier curves
and the log-rank test, respectively.

Our other time-to-event outcomes, ICU and hospital discharge and liberation from
mechanical ventilation, have a competing risk of death, meaning that patients
who die do not have the opportunity to experience the outcome. Traditional
survival analysis assumes that that the reason for censoring is independent of
the outcome; here, that is not the case. Kaplan-Meier curves would be misleading
in these scenarios, because they do not take this "competing risk" into account.
Therefore, we describe together the cumulative incidences of both the outcome of
interest and death, along with score tests for the difference between groups in
the subdistribution of interest. Generally, the `r with(ptsummary_df, sum(studywd_ih == "Yes" & hospdis_noinfo))` patients who withdrew in the hospital with no discharge or death information available are censored at the time of withdrawal; we censor at x.01 days anyone who has experienced neither death nor the outcome of interest by x days, where x is the time frame for the
specified outcome. More details on censoring are provided with each analysis.

## Adjusted Analysis{#adjusted}

### Multivariable Modeling

We perform multivariable regression analyses to explore the association between
treatment group and our outcome variables while adjusting for potential baseline
confounders. Though these covariates should be balanced between treatment groups
thanks to randomization, adjustment increases our power and precision. We
performed a redundancy analysis[^rms] to ensure that no covariates completely
explain any of the others (resulting in collinearity); see [above](#exploration). No covariates suggest evidence of too-high collinearity.

[^rms]: Harrell, Frank E. (2015) *Regression Modeling Strategies.* New York, NY: Springer.

In addition, we adjust all coefficient variances using Huber-White sandwich
estimation, clustered by study site. This will help account for unmeasured
variability and correlation among patients within a given site.

### In-Hospital Continuous Outcomes

We use proportional odds logistic regression for continuous outcomes
(delirium/coma-free days, delirium duration, and coma duration); this method
assumes an ordinal outcome but does not assume that it follows a specific
statistical distribution.

### Time to Event Outcomes

We use Cox proportional hazards regression for mortality. For all other time to
event outcomes (ICU and hospital discharge and liberation from mechanical
ventilation), we use competing risks regression[^fg], treating death as our
competing risk. Generally, the `r with(ptsummary_df, sum(studywd_ih == "Yes" & hospdis_noinfo))` patients who withdrew in the hospital with no discharge or
death information available are censored at the time of withdrawal; we censor at
x.01 days anyone who has experienced neither death nor the outcome of interest
by x days, where x is the time frame in question (14 days for liberation from
mechanical ventilation; 90 days for ICU and hospital discharge). More details on
censoring are provided with each analysis.

[^fg]: Fine, J., & Gray, R. (1999). A Proportional Hazards Model for the Subdistribution of a Competing Risk. *Journal of the American Statistical Association*, 94(446), 496-509. doi:10.2307/2670170

### Model Assumptions{#assumptions}

We check proportional odds and proportional hazards assumptions graphically for
each model. When checking the proportional odds assumption, something may be
amiss if Y axis values (estimated coefficient at various cutoffs of our outcome)
change substantially across the X axis, particularly if the effect changes
direction (noted by the dotted line at 0). For further discussion, please see
Harrell's *Regression Modeling Strategies*, section 13.3.[^rms]

For the proportional hazard assumption, we are looking for fairly flat
associations between beta coefficients (Y axis) and time (X axis), which would
indicate that the hazard remains constant over time.

### Covariates{#covariates}

All multivariable models are adjusted for the following baseline covariates, in
addition to treatment group:

- Age at study consent
- Preexisting CI, via the IQCODE (performed via patient or surrogate questionnaire)
- Preexisting frailty, via the CSHA Clinical Frailty Score
- Preexisting comorbidities, via the Charlson Comorbidities Index
- SOFA on the day of randomization, excluding the CNS component
- Level of arousal at randomization, via the RASS closest to the time of randomization

Age, CFS, and Charlson are all allowed to have a nonlinear relationship with our outcome, using restricted cubic splines with `r rcsknots` knots. The distribution of IQCODE `r spark_iqcode` (`r rndformat(mean_na(model_df$iqcode_total_ph == 3) * 100, 0)`% of patients had a score of exactly 3) has too little variability to allow this flexibility.

## Effect Modification

We are interested in whether any association between treatment group and our
main outcomes is modified by several factors. In secondary analyses, we include
interaction (or cross-product) terms in our multivariable models between
treatment and the following variables:

- Age at consent
- Severity of illness, measured by modified SOFA on the day of randomization
- Pre-existing cognitive impairment, measured by IQCODE at consent
- Medical vs surgical patient as defined by... `waiting on definition from PP, AM`

## Missing Data

We have very little missing covariate or outcome data (see [above](#exploration)
for further details); therefore, we use complete case analysis for all
in-hospital outcomes. From models which would include all `r n_rand` randomized patients (all except liberation from mechanical ventilation), complete case
analysis excludes `r pts_missany %>% pull(nmiss)` (`r rndformat(pts_missany %>% pull(pctmiss), 0)`%).

We do use single imputation for missing mental status on a daily basis, to
reduce potential bias from the `r round(mean(is.na(subset(daily_int_df, study_status == "Intervention")$mental_status_raw)) * 100)`% of patient-days during the intervention period without sufficient RASS and/or CAM information to
determine mental status. Please see [Notes on Variable Calculation](#dcfds) for
further rationale and details.

## Software Summary

We used `r R.version$version.string` for all analyses. Full package details can
be found [below](#software); specific packages used for major components include:

```{r main_pkgs}
## Join table indicating purposes for major packages we want to highlight
pkg_uses <- tribble(
  ~ package, ~ reason,
  # "naniar",    "Missing data exploration",
  "cmprsk",    "Competing risks survival analysis",
  "survival",  "General survival analysis",
  "survminer", "Presentation of survival data",
  "rms",       "Multivariable regression"
)

devtools::session_info()$packages %>%
  filter(package %in% pkg_uses$package) %>%
  left_join(pkg_uses, by = "package") %>%
  dplyr::select(package, version, date, source, reason) %>%
  kable(
    format = "html",
    col.names = c("Package", "Version", "Updated", "Source", "Used for"),
    align = c("l", "r", "r", "c")
  ) %>%
  mykablestyle()

```

This RMarkdown file **will, upon final analysis prior to submission**, include a [`checkpoint()`](https://cran.r-project.org/web/packages/checkpoint/vignettes/checkpoint.html) call setting the date to the date final primary analysis was run. That date will be specified here.

# Primary Analysis

This section includes analyses for the entire randomized cohort, with no potential effect modification (no interaction terms).

<hr>

```{r mental_outcomes_prep}
## -- Info and text strings for % of days that had to be imputed ---------------
## How many days are missing status which should have it?
miss_mental <- sum(
  is.na(
    subset(
      daily_int_df,
      study_day < 14 & study_status %in% c("Intervention", "Withdrawn")
    )$mental_status_raw
  )
)
days_inhosp <- nrow(
  subset(
    daily_int_df,
    study_day < 14 & study_status %in% c("Intervention", "Withdrawn")
  )
)
days_all <- nrow(subset(daily_int_df, study_day < 14))

## Caption to include on all mental status charts
days_miss_caption <- glue(
  "\n\nAmong in-hospital days, ",
  "{rndformat((miss_mental / days_inhosp) * 100, 0)}%",
  " had insufficient CAM and/or RASS available to determine mental",
  " status;\n",
  "among all days in the intervention period (including those after death or",
  " discharge), this percentage is ",
  "{rndformat((miss_mental / days_all) * 100, 0)}%."
)

## What % of in-hospital days had to be imputed?
pct_imputed_ih <-
  with(subset(daily_int_df, study_status %in% c("Intervention", "Withdrawn")), {
    round(mean(is.na(mental_status_raw)) * 100)
  })

## Text string for each section of mental status outcomes
mental_imp_text <- glue(
  "***Note**: We use single imputation to reduce potential bias from the ",
  "{pct_imputed_ih}% of patient-days during the intervention period without ",
  " sufficient RASS and/or CAM information to determine mental status. Please ",
  " see [Notes on Variable Calculation](#dcfds) for further rationale.*"
)

## -- Setup for Liu & Shepherd's functions to calculate conditional median, ----
## -- CI for POLR models (see chunk orm_functions) -----------------------------

## First step: create newdata with median, mode values
## We can use datadist() to our advantage here. In the $limits element, the
##  second value for each variable is `Adjust to` and is by default the median
##  or mode. We'll also need to manually include the values for any associated
##  spline terms.

## First: Get locations of knots for all continuous covariates
knot_locations <- set_names(
  map(
    cont_covars,
    ~ rcspline.eval(model_df[, .], nk = rcsknots, knots.only = TRUE)
  ),
  cont_covars
)

## Function to get value(s) of each covariate to adjust predicted values to
##   (median/mode, plus any spline terms)
get_adjvals <- function(
  vname,                      ## string; variable name (must be in dd)
  ddist,                      ## datadist() object
  use_rcs = TRUE,             ## whether to include spline terms
  knot_locs = knot_locations  ## locations of knots for variable vname
){
  ## We'll return every result as a data.frame with reasonable names,
  ##  so it can be easily cbinded later
  
  ## base_value = "Adjust to" value for vname
  base_value <- ddist$limits[2, vname]
  
  ## If we're using splines in this model, and variable is in our list of
  ## variables we use with splines (that's in the global env SORRY), use
  ## rcspline.eval() to extract both original and spline term values
  if(use_rcs && vname %in% cont_covars){
    df <- rcspline.eval(
      base_value, knots = pluck(knot_locs, vname), inclx = TRUE
    ) %>%
      as.data.frame()
    
    ## Set reasonable column names: eg, "age", "age_2"
    names(df) <- map_chr(1:ncol(df), ~ paste(vname, ., sep = "_")) %>%
      str_replace("\\_1", "")
  } else{
    ## If variable doesn't use splines, return base_value as a data.frame
    df <- set_names(as.data.frame(base_value), vname)
  }
  
  return(df)
}

```

## Delirium/Coma-Free Days

`r mental_imp_text`

### Unadjusted Analysis

Due to the non-normal distribution of DCFDs `r spark_dcfd`, our primary
unadjusted analysis uses a Kruskal-Wallis test to look for any differences in
distribution of this outcome between the three treatment groups. Please see [the
Methods section](#unadjusted) for more details. All `r n_rand` randomized
patients are included.

`[insert general summary of results here]`

```{r dcfds_unadj, results = "hide"}
## -- Test DCFDs by treatment group --------------------------------------------
dcfd_kw <- with(ptsummary_df, kruskal.test(x = dcfd_int, g = trt))

## -- Plot DCFDs by treatment group; include K-W results as subtitle -----------
dcfd_plot <- mental_plot(
  xvar = "dcfd_int", xtitle = "Delirium/Coma-Free Days", kw_obj = dcfd_kw
)

```

```{r print_dcfds_unadj, fig.width = 7.5, fig.height = 4}
dcfd_plot

```

### Adjusted Analysis

`[insert general summary of results here]`

#### Model Fitting and Assumptions {.tabset}

##### Model Fitting

We use proportional odds logistic regression to look at the association between
treatment and DCFDs during the intervention period, adjusting for baseline
patient characteristics. Please see [the Methods section](#adjusted) for more
details. All `r n_rand_comp` randomized patients with complete covariate data
are included.

```{r dcfds_adj}
## Primary model fit using rms::orm(), because Liu & Shepherd have some nice
##  functions for getting means, etc from this. My function to check PO
##  assumption assumes rms::lrm() fit; one day I should make this flexible, but
##  for now, fit it twice. Results are identical when both use default options.
dcfd_mod <- orm(
  as.formula(paste("dcfd_int ~", mod_rhs)),
  data = model_df,
  x = TRUE, y = TRUE
) %>%
  robcov(cluster = model_df$study_site)

dcfd_mod_lrm <- lrm(
  as.formula(paste("dcfd_int ~", mod_rhs)),
  data = model_df,
  x = TRUE, y = TRUE
) %>%
  robcov(cluster = model_df$study_site)

```

##### Assumptions

We are looking for fairly flat lines, paying particular attention to panels
representing treatment groups. Please see the [Methods section](#assumptions)
for further details.

```{r dcfds_assume}
JTHelpers::rms_po_assume(
  dcfd_mod_lrm,
  cuts = seq(1, 12, 1),
  modelData = model_df
) +
  labs(title = "PO assumption for DCFDs") +
  theme(axis.text = element_text(size = 8))

```

#### Model Results {.tabset}

We show the odds ratios (using placebo as reference) and adjusted medians for
DCFDs by treatment group. All results are shown visually, with tables included
for exact numbers if desired.

TREATMENTS ARE ONCE AGAIN COMPLETELY FAKE

##### Adjusted Odds Ratios

Odds ratios **higher** than 1 are favorable, indicating higher odds of more
"good" days alive and free of brain dysfunction.

```{r dcfd_ors, fig.width = 5, fig.height = 3}
## -- Create dataset of values to use when calculating conditional medians -----
## Since we use the same covariates for all three models, can use this dataset
## 1. Create data frame with a single row, excluding treatment values
##  (we'll add those later)
pred_df_org <- map_dfc(
  setdiff(c(cont_covars, notcont_covars), "trt"),
  get_adjvals,
  ddist = dd
)

## 2. Repeat those values by row; # rows = # different treatments
pred_df <- rep(list(pred_df_org), length(levels(model_df$trt))) %>%
  bind_rows() %>%
  ## Add treatment levels
  bind_cols(trt = levels(model_df$trt)) %>%
  ## Create a model.matrix object, then leave out the intercept
  ##   model.matrix() handles dummy variables for categoricals nicely
  model.matrix(
    as.formula(sprintf("~ %s", paste(names(.), collapse = " + "))),
    .
  ) %>%
  as.data.frame() %>%
  dplyr::select(-1) %>%
  ## colnames must be the same as names(coef(model))
  ## We're using the same covariates for all models, so we can just use one
  set_names(str_subset(names(coef(dcfd_mod)), "^[^y>=]"))

## -- Calculate, plot odds ratios for both treatments vs placebo ---------------
dcfd_ors <- trt_ratios(mod = dcfd_mod)

dcfd_ors_plot <- plot_trt_ratios(
  ratio_df = dcfd_ors,
  "Delirium/Coma-Free Days",
  mod = dcfd_mod
)

dcfd_ors_plot

```

##### Adjusted Medians

Medians are adjusted to the median/mode values of all covariates, so that each
represents the expected median number of DCFDs for a patient in each treatment
group who is otherwise part of a "typical" *(many air quotes)* population.

```{r dcfd_medians, fig.width = 5, fig.height = 3}
## Get adjusted medians + bounds for each treatment group
dcfd_adjmeds <- quantile_orm_df(mod = dcfd_mod)

## Plot medians + CIs
dcfd_adjmeds_plot <- mental_medians_plot(dcfd_adjmeds, dcfd_mod)

dcfd_adjmeds_plot

```

##### Results for All Covariates

Since most of the continuous covariates are modeled using restricted cubic
splines (see the [Methods section](#covariates) for more details), a single odds
ratio/CI is insufficient to describe the entire relationship between each of
these covariates and DCFDs. Rather, each odds ratio reflects a comparison
between two specific values of the covariate, as noted in the table.

```{r dcfd_full_results, warning = FALSE}
rms_results_kable(dcfd_mod_lrm)

```

## Delirium Duration

Delirium duration is an imperfect measure, since patients who die quickly can
have a short duration and appear to have better outcomes than they actually do.
It is included as a way to help elucidate any association between treatment and
our blunt primary outcome of DCFDs, which incorporates delirium and coma
durations as well as death.

`r mental_imp_text`

### Unadjusted Analysis

Due to the non-normal distribution of delirium duration `r spark_del`, our
primary unadjusted analysis uses a Kruskal-Wallis test to look for any
differences in distribution of this outcome between the three treatment groups.
Please see [the Methods section](#unadjusted) for more details. All `r n_rand`
randomized patients are included.

`[insert general summary of results here]`

```{r del_unadj, results = "hide"}
## -- Test delirium duration by treatment group --------------------------------
del_kw <- with(model_df, kruskal.test(x = del_int_all, g = trt))

## -- Plot DCFDs by treatment group; include K-W results as subtitle -----------
del_plot <- mental_plot(
  xvar = "del_int_all", xtitle = "Delirium Duration", kw_obj = del_kw
)

```

```{r print_del_unadj, fig.width = 7.5, fig.height = 4}
del_plot

```

### Adjusted Analysis

`[insert general summary of results here]`

#### Model Fitting and Assumptions {.tabset}

##### Model Fitting

We use proportional odds logistic regression to look at the association between
treatment and delirium duration during the intervention period, adjusting for
baseline patient characteristics. Please see [the Methods section](#adjusted)
for more details. All `r n_rand_comp` randomized patients with complete
covariate data are included.

```{r del_adj}
## Primary model fit using rms::orm(), because Liu & Shepherd have some nice
##  functions for getting means, etc from this. My function to check PO
##  assumption assumes rms::lrm() fit; one day I should make this flexible, but
##  for now, fit it twice. Results are identical when both use default options.
del_mod <- orm(
  as.formula(paste("del_int_all ~", mod_rhs)),
  data = model_df,
  x = TRUE, y = TRUE
) %>%
  robcov(cluster = model_df$study_site)

del_mod_lrm <- lrm(
  as.formula(paste("del_int_all ~", mod_rhs)),
  data = model_df,
  x = TRUE, y = TRUE
) %>%
  robcov(cluster = model_df$study_site)

```

##### Assumptions

We are looking for fairly flat lines, paying particular attention to panels
representing treatment groups. Please see the [Methods section](#assumptions)
for further details.

```{r del_assume}
JTHelpers::rms_po_assume(
  del_mod_lrm,
  cuts = seq(2, 7, 1),
   ## Minimum value anyone should have is 1; start at >=2. Distribution after
   ## 7 is very sparse; no real reason to look, since it would be very noisy.
  modelData = model_df
) +
  labs(title = "PO assumption for delirium duration") +
  theme(axis.text = element_text(size = 8))

```

#### Model Results {.tabset}

We show the odds ratios (using placebo as reference) and adjusted medians for
delirium duration by treatment group. All results are shown visually, with
tables included for exact numbers if desired.

TREATMENTS ARE ONCE AGAIN COMPLETELY FAKE

##### Adjusted Odds Ratios

Odds ratios **lower** than 1 are favorable, indicating lower odds of more days
with delirium.

```{r del_ors, fig.width = 5, fig.height = 3}
## -- Calculate, plot odds ratios for both treatments vs placebo ---------------
del_ors <- trt_ratios(mod = del_mod)

del_ors_plot <- plot_trt_ratios(
  ratio_df = del_ors,
  "Delirium Duration",
  mod = del_mod
)

del_ors_plot

```


##### Adjusted Medians

Medians are adjusted to the median/mode values of all covariates, so that each
represents the expected median number of days with delirium for a patient in
each treatment group who is otherwise part of a "typical" *(many air quotes)*
population.

```{r del_medians, fig.width = 5, fig.height = 3}
## Get adjusted medians + bounds for each treatment group
del_adjmeds <- quantile_orm_df(mod = del_mod)

## Plot medians + CIs
del_adjmeds_plot <- mental_medians_plot(del_adjmeds, del_mod)

del_adjmeds_plot

```

##### Results for All Covariates

Since most of the continuous covariates are modeled using restricted cubic
splines (see the [Methods section](#covariates) for more details), a single odds
ratio/CI is insufficient to describe the entire relationship between each of
these covariates and delirium duration. Rather, each odds ratio reflects a
comparison between two specific values of the covariate, as noted in the table.

```{r del_full_results, warning = FALSE}
rms_results_kable(del_mod_lrm)

```

## Coma Duration

Coma duration is an imperfect measure, since patients who die quickly can have a
short duration and appear to have better outcomes than they actually do. It is
included as a way to help elucidate any association between treatment and our
blunt primary outcome of DCFDs, which incorporates delirium and coma durations
as well as death.

`r mental_imp_text`

### Unadjusted Analysis

Due to the non-normal distribution of coma duration `r spark_coma`, our
primary unadjusted analysis uses a Kruskal-Wallis test to look for any
differences in distribution of this outcome between the three treatment groups.
Please see [the Methods section](#unadjusted) for more details. All `r n_rand`
randomized patients are included.

`[insert general summary of results here]`

```{r coma_unadj, results = "hide"}
## -- Test coma duration by treatment group ------------------------------------
coma_kw <- with(model_df, kruskal.test(x = coma_int_all, g = trt))

## -- Plot coma duration by treatment; include K-W results as subtitle ---------
coma_plot <- mental_plot(
  xvar = "coma_int_all", xtitle = "Coma Duration", kw_obj = coma_kw
)

```

```{r print_coma_unadj, fig.width = 7.5, fig.height = 4}
coma_plot

```

### Adjusted Analysis

`[insert general summary of results here]`

#### Model Fitting and Assumptions {.tabset}

##### Model Fitting

We use proportional odds logistic regression to look at the association between
treatment and coma duration during the intervention period, adjusting for
baseline patient characteristics. Please see [the Methods section](#adjusted)
for more details. All `r n_rand_comp` randomized patients with complete
covariate data are included.

```{r coma_adj}
## Primary model fit using rms::orm(), because Liu & Shepherd have some nice
##  functions for getting means, etc from this. My function to check PO
##  assumption assumes rms::lrm() fit; one day I should make this flexible, but
##  for now, fit it twice. Results are identical when both use default options.
coma_mod <- orm(
  as.formula(paste("coma_int_all ~", mod_rhs)),
  data = model_df,
  x = TRUE, y = TRUE
) %>%
  robcov(cluster = model_df$study_site)

coma_mod_lrm <- lrm(
  as.formula(paste("coma_int_all ~", mod_rhs)),
  data = model_df,
  x = TRUE, y = TRUE
) %>%
  robcov(cluster = model_df$study_site)

```

##### Assumptions

We are looking for fairly flat lines, paying particular attention to panels
representing treatment groups. Please see the [Methods section](#assumptions)
for further details.

```{r coma_assume}
JTHelpers::rms_po_assume(
  coma_mod_lrm,
  cuts = seq(1, 6, 1),
   ## Distribution after 6 is very sparse; no real reason to look, since it
   ## would be very noisy.
  modelData = model_df
) +
  labs(title = "PO assumption for coma duration") +
  theme(axis.text = element_text(size = 8))

```

#### Model Results {.tabset}

We show the odds ratios (using placebo as reference) and adjusted medians for
coma duration by treatment group. All results are shown visually, with tables
included for exact numbers if desired.

TREATMENTS ARE ONCE AGAIN COMPLETELY FAKE

##### Adjusted Odds Ratios

Odds ratios **lower** than 1 are favorable, indicating lower odds of more days
with coma.

```{r coma_ors, fig.width = 5, fig.height = 3}
## -- Calculate, plot odds ratios for both treatments vs placebo ---------------
coma_ors <- trt_ratios(mod = coma_mod)

coma_ors_plot <- plot_trt_ratios(
  ratio_df = coma_ors, "Coma Duration", mod = coma_mod
)

coma_ors_plot

```

##### Adjusted Medians

Medians are adjusted to the median/mode values of all covariates, so that each
represents the expected median number of days with coma for a patient in each
treatment group who is otherwise part of a "typical" *(many air quotes)*
population.

```{r coma_medians, fig.width = 5, fig.height = 3}
## Get adjusted medians + bounds for each treatment group
coma_adjmeds <- quantile_orm_df(mod = coma_mod)

## Plot medians + CIs
coma_adjmeds_plot <- mental_medians_plot(coma_adjmeds, coma_mod)

coma_adjmeds_plot

```

##### Results for All Covariates

Since most of the continuous covariates are modeled using restricted cubic
splines (see the [Methods section](#covariates) for more details), a single odds
ratio/CI is insufficient to describe the entire relationship between each of
these covariates and coma duration. Rather, each odds ratio reflects a
comparison between two specific values of the covariate, as noted in the table.

```{r coma_full_results, warning = FALSE}
rms_results_kable(coma_mod_lrm)

```

## Time to Death

We explore the association between treatment and time to death from all causes
within the 30 and 90 days following randomization.

### Censoring and Time to Event

#### 30-Day Mortality

- The `r with(ptsummary_df, sum(studywd_ih == "Yes" & hospdis_noinfo))` patients
who withdrew from the study prior to day 30 with no known death status are censored at the time of withdrawal.
- The `r with(ptsummary_df, sum(!hospdis_noinfo & !event_death_30 & tte_death_30 == 30.01))` patients who survived the entire 30-day period are censored at day
30.01.
- The `r with(ptsummary_df, sum(!hospdis_noinfo & event_death_30 & tte_death_30 < 30.01))` patients who died within the 30-day period are assigned a time value
of `time of death - time of randomization`.

#### 90-Day Mortality

- The `r with(ptsummary_df, sum(studywd_ih == "Yes" & hospdis_noinfo))` patients
who withdrew from the study prior to day 90 with no known death status are censored at the time of withdrawal.
- The `r with(ptsummary_df, sum(!hospdis_noinfo & !event_death_90 & tte_death_90 == 90.01))` patients who survived the entire 90-day period are censored at day
90.01.
- The `r with(ptsummary_df, sum(!hospdis_noinfo & event_death_90 & tte_death_90 < 90.01))` patients who died within the 90-day period are assigned a time value
of `time of death - time of randomization`.

### Unadjusted Analysis{.tabset}

Our unadjusted analysis describes survival using Kaplan-Meier curves and tests
for differences among treatment groups in time to death within 30 and within 90
days of randomization using the log-rank test. All `r n_rand` randomized
patients are included.

`[insert general summary of results here]`

```{r death_unadj}
## -- Create Surv, survfit objects for time to death ---------------------------
surv_death_30 <-
  with(model_df, Surv(time = tte_death_30, event = event_death_30))
sf_death_30 <- survfit(surv_death_30 ~ trt, data = model_df)

surv_death_90 <-
  with(model_df, Surv(time = tte_death_90, event = event_death_90))
sf_death_90 <- survfit(surv_death_90 ~ trt, data = model_df)

## -- Log-rank test ------------------------------------------------------------
logrank_death_30 <- survdiff(surv_death_30 ~ trt, data = model_df)
logrank_death_90 <- survdiff(surv_death_90 ~ trt, data = model_df)

## -- Create KM curves, N at risk tables ---------------------------------------
km_death_30 <- km_plot_death(sf = sf_death_30, lr = logrank_death_30, time = 30)
km_death_90 <- km_plot_death(sf = sf_death_90, lr = logrank_death_90, time = 90)

```

#### 30-Day Death

```{r death_30_km, fig.width = 7.5, fig.height = 6}
km_death_30

```

#### 90-Day Death

```{r death_90_km, fig.width = 7.5, fig.height = 6}
km_death_90

```

### Adjusted Analysis

`[insert general summary of results here]`

#### Model Fitting and Assumptions {.tabset}

We perform multivariable regression analyses using a Cox proportional hazards
model to explore the association between treatment group and time to death while
adjusting for potential baseline confounders. Please see the [Methods
section](#adjusted) for more details. All `r n_rand_comp` randomized patients
with complete covariate data are included.

##### Model Fitting

```{r death_adj, results = "hide"}
death_30_mod <- cph(
  as.formula(paste("surv_death_30 ~", mod_rhs)),
  data = model_df,
  x = TRUE, y = TRUE
) %>%
  robcov(cluster = model_df$study_site)

death_90_mod <- cph(
  as.formula(paste("surv_death_90 ~", mod_rhs)),
  data = model_df,
  x = TRUE, y = TRUE
) %>%
  robcov(cluster = model_df$study_site)

```

##### Assumptions, 30-Day Death

We are looking for generally flat lines, indicating consistent hazards over time
and paying particular attention to treatment group. For more details, please see
the [Methods section](#assumptions).

```{r death_30_assume}
## -- Check proportional hazard assumption -------------------------------------
death_30_zph <- cox.zph(death_30_mod, transform = 'log')

## Extract p-value for global PH assumption; create reproducible statement
death_30_phtext <- text_ph_assume(death_30_zph)

```

`r death_30_phtext`

```{r death_30_assumeplot}
plot_ph_assume(death_30_zph)

```

##### Assumptions, 90-Day Death

We are looking for generally flat lines, indicating consistent hazards over time
and paying particular attention to treatment group. For more details, please see
the [Methods section](#assumptions).

```{r death_90_assume}
## -- Check proportional hazard assumption -------------------------------------
death_90_zph <- cox.zph(death_90_mod, transform = 'log')

## Extract p-value for global PH assumption; create reproducible statement
death_90_phtext <- text_ph_assume(death_90_zph)

```

`r death_90_phtext`

```{r death_90_assumeplot}
plot_ph_assume(death_90_zph)

```

#### Model Results {.tabset}

##### Hazard Ratios {.tabset}

```{r death_hrs}
## -- Calculate, plot hazard ratios for both treatments vs placebo -------------
death_30_hrs <- trt_ratios(death_30_mod)
death_90_hrs <- trt_ratios(death_90_mod)

## Create example text for interpretation
death_30_text <- hr_example(hr_df = death_30_hrs, outcome = "death")
death_90_text <- hr_example(hr_df = death_90_hrs, outcome = "death")

```

We show the hazard ratios for haloperidol and ziprasidone vs placebo. Hazard
ratios **lower** than 1 are favorable, indicating lower likelihood of death at
any given time point within 30 days of randomization, given that the patient has
survived up to that point. `r death_30_text[["Haloperidol"]]`

TREATMENTS ARE ONCE AGAIN COMPLETELY FAKE

###### 30-Day Death

```{r death_30_hrs_plot, fig.width = 5, fig.height = 3}
death_30_hrs_plot <- plot_trt_ratios(
  ratio_df = death_30_hrs,
  outcome_text = "All-Cause Death",
  extra_text = glue(
    "Includes deaths within 30 days of randomization.\n",
    "Patients who withdrew & revoked access to PHI are censored on the day of withdrawal."
  ),
  mod = death_30_mod
)

death_30_hrs_plot

```

###### 90-Day Death

```{r death_90_hrs_plot, fig.width = 5, fig.height = 3}
death_90_hrs_plot <- plot_trt_ratios(
  ratio_df = death_90_hrs,
  outcome_text = "All-Cause Death",
  extra_text = glue(
    "Includes deaths within 90 days of randomization.\n",
    "Patients who withdrew & revoked access to PHI are censored on the day of withdrawal."
  ),
  mod = death_90_mod
)

death_90_hrs_plot

```

##### Results for All Covariates {.tabset}

Since most of the continuous covariates are modeled using restricted cubic
splines (see the [Methods section](#covariates) for more details), a single
hazard ratio/CI is insufficient to describe the entire relationship between each
of these covariates and death. Rather, each hazard ratio reflects a comparison
between two specific values of the covariate, as noted in the table.

###### 30-Day Death

```{r death_30_full_results, warning = FALSE}
rms_results_kable(death_30_mod)

```

###### 90-Day Death

```{r death_90_full_results, warning = FALSE}
rms_results_kable(death_90_mod)

```

## Time to Successful ICU Discharge

We use time to event analysis with competing risks to explore the relationship
between treatment group and "successful" ICU discharge, defined as the final ICU
discharge from the study hospitalization, followed by at least 48 hours alive.
We treat death as a competing risk, and look at successful ICU discharge up to
90 days after randomization.

**Censoring and time to events:**

- We censor at the time of study withdrawal `r with(ptsummary_df, sum(ftype_icudis_90 == "Censored" & tte_icudis_90 < 90.01))` patients who
withdrew from the study prior to hospital discharge, with no discharge or death
information available.
- We censor at day 90.01 `r with(ptsummary_df, sum(ftype_icudis_90 == "Censored" & tte_icudis_90 == 90.01))` patients who survived the entire 90-day period but
remained in the ICU on day 90.
- We assign the `r with(ptsummary_df, sum(ftype_icudis_90 == "Death"))` patients who died prior to ICU discharge within the 90-day period a time value of `time of death - time of randomization` and a "failure type" of death; we assign the `r with(ptsummary_df, sum(ftype_icudis_90 == "ICU Discharge"))` patients who
were successfully discharged within the 90-day period a time value of `time of discharge - time of randomization` and a "failure type" of ICU discharge.

### Unadjusted Analysis

We present cumulative incidence plots by treatment group for both ICU discharge
and death, unadjusted for any covariates. Please see the [Methods
section](#unadjusted) for more details. All `r n_rand` randomized patients are
included.

`[insert general summary of results here]`

```{r cuminc_icudis_unadj, warning = FALSE, fig.height = 6, fig.width = 8}
## -- Create Surv object -------------------------------------------------------
## Will be used for N at risk for CIF, as well as adjusted model fit
icudis_90_Surv <- with(model_df, {
  Surv(time = tte_icudis_90, event = ftype_icudis_90, type = "mstate")
})

## -- Create and summarize survfit object, create N at risk table --------------
icudis_90_survfit <- survfit(icudis_90_Surv ~ trt, data = model_df)
icudis_90_sfsum <- summary(icudis_90_survfit, times = seq(0, 90, 15))

icudis_90_risk_plot <- cr_risktable_plot(
  icudis_90_sfsum,
  main_event = "ICU Discharge",
  event_string = "ICU discharges"
)

## -- Fit cumulative incidence functions by treatment --------------------------
icudis_90_cif <- with(model_df, {
  cuminc(
    ftime = tte_icudis_90,
    fstatus = ftype_icudis_90,
    group = trt,
    cencode = "Censored"
  )
})

## Create strings for test results
icudis_90_tests_unadj <- cuminc_test(icudis_90_cif)

## -- Plot CIFs, N at risk -----------------------------------------------------
## Create plot for competing risks
icudis_90_cif_plot <- cif_plot(
  cuminc_obj = icudis_90_cif,
  legend_string = "ICU Discharge",
  event_string = "Successful ICU Discharge",
  test_string = icudis_90_tests_unadj,
  caption_string = '"Successful" is defined as final ICU discharge followed by at least 48 hours alive.'
)

## Print combined plot
cr_combine_plots(
  cif = icudis_90_cif_plot,
  rt = icudis_90_risk_plot,
  xmax = 91, time_breaks = seq(0, 90, 15),
  caption_string = '"Successful" is defined as final ICU discharge followed by at least 48 hours alive.'
)

```

### Adjusted Analysis

`[insert general summary of results here]`

#### Model Fitting and Assumptions {.tabset}

We use Fine & Gray's[^fg] method of competing risks regression to examine the
relationship between treatment and (primarily) ICU discharge. For further
details, please see the [Methods section](#adjusted). All `r n_rand_comp` randomized patients with complete covariate data are included.

##### Model Fitting

```{r icudis_90_adj}
## -- Fit competing risks model using survival::finegray(), rms::cph() ---------
## Note: I tested three separate methods to make sure results were consistent:
## cmprsk, survival, and rms. Results in this gist:
## https://gist.github.com/jenniferthompson/c66d1aa6060d3e8919ea917f7aa94288

## -- Create dataset specifically for Fine-Gray method of competing risks ------
icudis_90_fg <- finegray(
  ## Use **linear** RHS here; we'll fit spline terms within model formula itself
  as.formula(paste("icudis_90_Surv ~", mod_rhs_lin)),
  data = model_df,
  etype = "ICU Discharge",
  id = id,
  count = "fgcount"
)

## -- Fit actual model, using variables/weights from finegray() ----------------
icudis_90_mod <- cph(
  as.formula(paste("Surv(fgstart, fgstop, fgstatus) ~", mod_rhs)),
  data = icudis_90_fg,
  weights = fgwt,
  x = TRUE, y = TRUE
)

```

##### Assumptions

```{r icudis_90_assume}
## -- Check proportional hazard assumption -------------------------------------
icudis_90_zph <- cox.zph(icudis_90_mod, transform = 'log')

## Extract p-value for global PH assumption; create reproducible statement
icudis_90_phtext <- text_ph_assume(icudis_90_zph)

```

We graphically check our assumption of proportional hazards for the ICU
discharge subdistribution, paying particular attention to treatment group and
looking for generally flat lines in each panel. `r icudis_90_phtext`

```{r icudis_90_assumeplot}
plot_ph_assume(icudis_90_zph)

```

#### Model Results {.tabset}

```{r icudis_90_hrs_prep}
## -- Calculate hazard ratios for both treatments vs placebo -------------------
icudis_90_hrs <- trt_ratios(icudis_90_mod)

## Create explanatory text string for subdistribution HRs
icudis_90_text <- hr_example(hr_df = icudis_90_hrs, outcome = "ICU discharge")

```

We show the subdistribution hazard ratios for ICU discharge for haloperidol and
ziprasidone vs placebo. Subdistribution hazard ratios **higher** than 1 are
favorable for this outcome. `r icudis_90_text[["Haloperidol"]]`

TREATMENTS ARE ONCE AGAIN COMPLETELY FAKE

##### Visual Form

```{r icudis_90_hrs_plot, fig.width = 5, fig.height = 3.5}
icudis_90_hrs_plot <- plot_trt_ratios(
  ratio_df = icudis_90_hrs,
  outcome_text = "Successful ICU Discharge",
  extra_text = glue(
    "\n\n",
    '"Successful": final ICU discharge within 30 days of randomization, ',
    "followed by at least 48 hours alive.\n",
    "Patients who withdrew & revoked access to PHI ",
    "are censored on the day of withdrawal.\n",
    "Deaths prior to ICU discharge are accounted for using competing risks."
  ),
  mod = icudis_90_mod
) +
  theme(plot.caption = element_text(size = basetext_size * 0.6))

icudis_90_hrs_plot

```

##### Tabular Form

```{r table_icudis_90_hrs}
table_trt_ratios(ratio_df = icudis_90_hrs)

```

##### Results for All Covariates

Since most of the continuous covariates are modeled using restricted cubic
splines (see the [Methods section](#covariates) for more details), a single
subdistribution hazard ratio/CI is insufficient to describe the entire
relationship between each of these covariates and the relative incidence of ICU
discharge. Rather, each subdistribution hazard ratio reflects a comparison
between two specific values of the covariate, as noted in the table.

```{r icudis_90_full_results, warning = FALSE}
rms_results_kable(icudis_90_mod)

```

## Time to Successful Hospital Discharge

We use time to event analysis with competing risks to explore the relationship
between treatment group and "successful" hospital discharge, defined as discharge from the study hospitalization, followed by at least 48 hours alive.
We treat death as a competing risk, and look at successful hospital discharge up
to 90 days after randomization.

**Censoring and time to events:**

- We censor at the time of study withdrawal `r with(ptsummary_df, sum(ftype_hospdis_90 == "Censored" & tte_hospdis_90 < 90.01))` patients who withdrew from the study prior to hospital discharge, with no discharge or death
information available.
- We censor at day 90.01 `r with(ptsummary_df, sum(ftype_hospdis_90 == "Censored" & tte_hospdis_90 == 90.01))` patients who survived the entire 90-day
period but remained hospitalized on day 90.
- We assign the `r with(ptsummary_df, sum(ftype_hospdis_90 == "Death"))` patients who died prior to ICU discharge within the 90-day period a time value
of `time of death - time of randomization` and a "failure type" of death; we
assign the `r with(ptsummary_df, sum(ftype_hospdis_90 == "Hospital Discharge"))`
patients who were successfully discharged within the 90-day period a time value
of `time of discharge - time of randomization` and a "failure type" of hospital
discharge.

### Unadjusted Analysis

We present cumulative incidence plots by treatment group for both hospital
discharge and death, unadjusted for any covariates. Please see the [Methods
section](#unadjusted) for more details. All `r n_rand` randomized patients are
included.

`[insert general summary of results here]`

```{r cuminc_hospdis_unadj, warning = FALSE, fig.height = 6, fig.width = 8}
## -- Create Surv object -------------------------------------------------------
## Will be used for N at risk for CIF, as well as adjusted model fit
hospdis_90_Surv <- with(model_df, {
  Surv(time = tte_hospdis_90, event = ftype_hospdis_90, type = "mstate")
})

## -- Create and summarize survfit object, create N at risk table --------------
hospdis_90_survfit <- survfit(hospdis_90_Surv ~ trt, data = model_df)
hospdis_90_sfsum <- summary(hospdis_90_survfit, times = seq(0, 90, 15))

hospdis_90_risk_plot <- cr_risktable_plot(
  hospdis_90_sfsum,
  main_event = "Hospital Discharge",
  event_string = "hospital discharges"
)

## -- Fit cumulative incidence functions by treatment --------------------------
hospdis_90_cif <- with(model_df, {
  cuminc(
    ftime = tte_hospdis_90,
    fstatus = ftype_hospdis_90,
    group = trt,
    cencode = "Censored"
  )
})

## Create strings for test results
hospdis_90_tests_unadj <- cuminc_test(hospdis_90_cif)

## -- Plot CIFs, N at risk -----------------------------------------------------
## Create plot for competing risks
hospdis_90_cif_plot <- cif_plot(
  cuminc_obj = hospdis_90_cif,
  legend_string = "Hospital Discharge",
  event_string = "Successful Hospital Discharge",
  test_string = hospdis_90_tests_unadj,
  caption_string = '"Successful" is defined as hospital discharge followed by at least 48 hours alive.'
)

## Print combined plot
cr_combine_plots(
  cif = hospdis_90_cif_plot,
  rt = hospdis_90_risk_plot,
  xmax = 91, time_breaks = seq(0, 90, 15),
  caption_string = '"Successful" is defined as hospital discharge followed by at least 48 hours alive.'
)

```

### Adjusted Analysis

`[insert general summary of results here]`

#### Model Fitting and Assumptions {.tabset}

We use Fine & Gray's[^fg] method of competing risks regression to examine the
relationship between treatment and (primarily) hospital discharge. For further
details, please see the [Methods section](#adjusted). All `r n_rand_comp` randomized patients with complete covariate data are included.

##### Model Fitting

```{r hospdis_90_adj}
## -- Fit competing risks model using survival::finegray(), rms::cph() ---------

## -- Create dataset specifically for Fine-Gray method of competing risks ------
hospdis_90_fg <- finegray(
  ## Use **linear** RHS here; we'll fit spline terms within model formula itself
  as.formula(paste("hospdis_90_Surv ~", mod_rhs_lin)),
  data = model_df,
  etype = "Hospital Discharge",
  id = id,
  count = "fgcount"
)

## -- Fit actual model, using variables/weights from finegray() ----------------
hospdis_90_mod <- cph(
  as.formula(paste("Surv(fgstart, fgstop, fgstatus) ~", mod_rhs)),
  data = hospdis_90_fg,
  weights = fgwt,
  x = TRUE, y = TRUE
)

```

##### Assumptions

```{r hospdis_90_assume}
## -- Check proportional hazard assumption -------------------------------------
hospdis_90_zph <- cox.zph(hospdis_90_mod, transform = 'log')

## Extract p-value for global PH assumption; create reproducible statement
hospdis_90_phtext <- text_ph_assume(hospdis_90_zph)

```

We graphically check our assumption of proportional hazards for the hospital
discharge subdistribution, paying particular attention to treatment group and
looking for generally flat lines in each panel. `r hospdis_90_phtext`

```{r hospdis_90_assumeplot}
plot_ph_assume(hospdis_90_zph)

```

#### Model Results {.tabset}

```{r hospdis_90_hrs_prep}
## -- Calculate hazard ratios for both treatments vs placebo -------------------
hospdis_90_hrs <- trt_ratios(hospdis_90_mod)

## Create explanatory text string for subdistribution HRs
hospdis_90_text <-
  hr_example(hr_df = hospdis_90_hrs, outcome = "hospital discharge")

```

We show the subdistribution hazard ratios for hospital discharge for haloperidol
and ziprasidone vs placebo. Subdistribution hazard ratios **higher** than 1 are
favorable for this outcome. `r hospdis_90_text[["Haloperidol"]]`

TREATMENTS ARE ONCE AGAIN COMPLETELY FAKE

##### Visual Form

```{r hospdis_90_hrs_plot, fig.width = 5, fig.height = 3.5}
hospdis_90_hrs_plot <- plot_trt_ratios(
  ratio_df = hospdis_90_hrs,
  outcome_text = "Successful Hospital Discharge",
  extra_text = glue(
    "\n\n",
    '"Successful": hospital discharge within 90 days of randomization, ',
    "followed by at least 48 hours alive.\n",
    "Patients who withdrew & revoked access to PHI ",
    "are censored on the day of withdrawal.\n",
    "Deaths prior to hospital discharge are accounted for using competing risks."
  ),
  mod = hospdis_90_mod
) +
  theme(plot.caption = element_text(size = basetext_size * 0.6),
        plot.title = element_text(size = basetext_size * 1.15))

hospdis_90_hrs_plot

```

##### Tabular Form

```{r table_hospdis_90_hrs}
table_trt_ratios(ratio_df = hospdis_90_hrs)

```

##### Results for All Covariates

Since most of the continuous covariates are modeled using restricted cubic
splines (see the [Methods section](#covariates) for more details), a single
subdistribution hazard ratio/CI is insufficient to describe the entire
relationship between each of these covariates and the relative incidence of
hospital discharge. Rather, each subdistribution hazard ratio reflects a
comparison between two specific values of the covariate, as noted in the table.

```{r hospdis_90_full_results, warning = FALSE}
rms_results_kable(hospdis_90_mod)

```

## Time to Successful Liberation from Mechanical Ventilation

We use time to event analysis with competing risks to explore the relationship
between treatment group and "successful" liberation from mechanical ventilation,
defined as discontinuation of all types of MV followed by at least 48 hours alive and without reinitiation of MV, during the 30 days following
randomization. We treat death and hospital discharge without liberation during
this time as separate competing risks.

**Censoring and time to events:**

- We censor at the time of study withdrawal `r with(ptsummary_df, sum(ftype_mvlib_30 == "Censored" & tte_mvlib_30 < 30.01 & hospdis_noinfo, na.rm = TRUE))` patients who withdrew from the study prior to hospital discharge,
with no discharge or death information available.
- We censor at day 30.01 `r with(ptsummary_df, sum_na(ftype_mvlib_30 == "Censored" & tte_mvlib_30 == 30.01))` patients who survived the entire 30-day
period after randomization, but remained hospitalized on day 30.
- We assign patients who experience the competing risks of either hospital discharge (`r with(ptsummary_df, sum_na(ftype_mvlib_30 == "Discharge" & tte_mvlib_30 < 30.01 & !hospdis_noinfo))` patients) or death (`r with(ptsummary_df, sum_na(ftype_mvlib_30 == "Death" & tte_mvlib_30 < 30.01 & !hospdis_noinfo))` patients) prior to 30 days a time to event of `time of discharge/death - time of randomization` and a "failure type" of hospital
discharge and death, respectively.
- We assign the `r with(ptsummary_df, sum_na(ftype_mvlib_30 == "MV Liberation"))` patients who were successfully liberated from MV within 30 days
of randomization a time value of `time of liberation - time of randomization`
and a "failure type" of liberation from MV.

### Unadjusted Analysis

We present cumulative incidence plots by treatment group for both liberation
from MV and death, unadjusted for any covariates. Please see the [Methods
section](#unadjusted) for more details. All `r  sum_na(ptsummary_df$on_mv_rand24)` randomized patients who were on MV within 24 hours after randomization are included.

`[insert general summary of results here]`

```{r cuminc_mvlib_unadj, warning = FALSE, fig.height = 6, fig.width = 8}
## Prep: Smaller df including only patients on MV within 24h of randomization
model_df_mv <- model_df %>% filter(on_mv_rand24)

## -- Create Surv object -------------------------------------------------------
## Will be used for N at risk for CIF, as well as adjusted model fit
mvlib_30_Surv <- with(model_df_mv, {
  Surv(time = tte_mvlib_30, event = ftype_mvlib_30, type = "mstate")
})

## -- Create and summarize survfit object, create N at risk table --------------
mvlib_30_survfit <- survfit(mvlib_30_Surv ~ trt, data = model_df_mv)
mvlib_30_sfsum <- summary(mvlib_30_survfit, times = c(0, seq(5, 30, 5)))

mvlib_30_risk_plot <- cr_risktable_plot(
  mvlib_30_sfsum,
  main_event = "MV Liberation",
  event_string = "liberations from MV"
)

## -- Fit cumulative incidence functions by treatment --------------------------
mvlib_30_cif <- with(model_df_mv, {
  cuminc(
    ftime = tte_mvlib_30,
    fstatus = ftype_mvlib_30,
    group = trt,
    cencode = "Censored"
  )
})

## Create strings for test results
mvlib_30_tests_unadj <- cuminc_test(mvlib_30_cif)

## -- Plot CIFs, N at risk -----------------------------------------------------
## Create plot for competing risks
mvlib_30_cif_plot <- cif_plot(
  cuminc_obj = mvlib_30_cif,
  legend_string = "Liberation from MV",
  event_string = "Successful Liberation from MV",
  test_string = mvlib_30_tests_unadj,
  caption_string = '"Successful" is defined as discontinuation of MV, followed by at least 48 hours alive without reinitiation.'
)

## Print combined plot
cr_combine_plots(
  cif = mvlib_30_cif_plot,
  rt = mvlib_30_risk_plot,
  xmax = 31, time_breaks = c(0, seq(5, 30, 5)),
  caption_string = '"Successful" is defined as discontinuation of MV, followed by at least 48 hours alive without reinitiation.'
)

```

### Adjusted Analysis

`[insert general summary of results here]`

#### Model Fitting and Assumptions {.tabset}

We use Fine & Gray's[^fg] method of competing risks regression to examine the
relationship between treatment and (primarily) successful liberation from MV.
For further details, please see the [Methods section](#adjusted). All `r with(model_df, sum_na(on_mv_rand24 & comp_covars))` randomized patients with
complete covariate data who received MV within 24 hours after randomization are
included.

##### Model Fitting

```{r mvlib_30_adj}
## -- Fit competing risks model using survival::finegray(), rms::cph() ---------

## -- Create dataset specifically for Fine-Gray method of competing risks ------
mvlib_30_fg <- finegray(
  ## Use **linear** RHS here; we'll fit spline terms within model formula itself
  as.formula(paste("mvlib_30_Surv ~", mod_rhs_lin)),
  data = model_df_mv,
  etype = "MV Liberation",
  id = id,
  count = "fgcount"
)

## -- Fit actual model, using variables/weights from finegray() ----------------
mvlib_30_mod <- cph(
  as.formula(paste("Surv(fgstart, fgstop, fgstatus) ~", mod_rhs)),
  data = mvlib_30_fg,
  weights = fgwt,
  x = TRUE, y = TRUE
)

```

##### Assumptions

```{r mvlib_30_assume}
## -- Check proportional hazard assumption -------------------------------------
mvlib_30_zph <- cox.zph(mvlib_30_mod, transform = 'log')

## Extract p-value for global PH assumption; create reproducible statement
mvlib_30_phtext <- text_ph_assume(mvlib_30_zph)

```

We graphically check our assumption of proportional hazards for the MV
liberation subdistribution, paying particular attention to treatment group and
looking for generally flat lines in each panel. `r mvlib_30_phtext`

```{r mvlib_30_assumeplot}
plot_ph_assume(mvlib_30_zph)

```

#### Model Results {.tabset}

```{r mvlib_30_hrs_prep}
## -- Calculate hazard ratios for both treatments vs placebo -------------------
mvlib_30_hrs <- trt_ratios(mvlib_30_mod)

## Create explanatory text string for subdistribution HRs
mvlib_30_text <-
  hr_example(hr_df = mvlib_30_hrs, outcome = "liberation from MV")

```

We show the subdistribution hazard ratios for hospital discharge for haloperidol
and ziprasidone vs placebo. Subdistribution hazard ratios **higher** than 1 are
favorable for this outcome. `r mvlib_30_text[["Haloperidol"]]`

TREATMENTS ARE ONCE AGAIN COMPLETELY FAKE

##### Visual Form

```{r mvlib_30_hrs_plot, fig.width = 5, fig.height = 3.5}
mvlib_30_hrs_plot <- plot_trt_ratios(
  ratio_df = mvlib_30_hrs,
  outcome_text = "Successful Liberation from MV",
  extra_text = glue(
    "\n\n",
    '"Successful": liberation from MV during the intervention period, ',
    "followed by at least 48 hours alive without reinitiation.\n",
    "Patients who withdrew & revoked access to PHI ",
    "are censored on the day of withdrawal.\n",
    "Deaths prior to liberation are accounted for using competing risks."
  ),
  mod = mvlib_30_mod
) +
  theme(plot.caption = element_text(size = basetext_size * 0.6),
        plot.title = element_text(size = basetext_size * 1.15))

mvlib_30_hrs_plot

```

##### Tabular Form

```{r table_mvlib_30_hrs}
table_trt_ratios(ratio_df = mvlib_30_hrs)

```

##### Results for All Covariates

Since most of the continuous covariates are modeled using restricted cubic
splines (see the [Methods section](#covariates) for more details), a single
subdistribution hazard ratio/CI is insufficient to describe the entire
relationship between each of these covariates and the relative incidence of
liberation from MV. Rather, each subdistribution hazard ratio reflects a
comparison between two specific values of the covariate, as noted in the table.

```{r mvlib_30_full_results, warning = FALSE}
rms_results_kable(mvlib_30_mod)

```

## Time to ICU Readmission

We use time to event analysis with competing risks to explore the relationship
between treatment group and readmission to the ICU within 90 days of first
discharge during the index hospitalization, among the `r sum_na(ptsummary_df$elig_readm)` patients who survived their first ICU stay and
remained in the study. We treat death and hospital discharge without readmission
during this time as separate competing risks.

Although the question of how _many_ times each patient was readmitted is also
of interest, we had so few patients who were readmitted >1 time (`r with(subset(ptsummary_df, elig_readm), sum_na(icu_readmit_number > 1))`, or `with(subset(ptsummary_df, elig_readm), round(mean_na(icu_readmit_number >1) * 100))`%) that it was not feasible to address this specific issue.

**Censoring and time to events:**

- We planned to censor at the time of study withdrawal patients who withdrew
from the study prior to hospital discharge with no discharge or death information available, but `r with(ptsummary_df, sum_na(elig_readm & ftype_readm_90 == "Censored" & tte_readm_90 < 90.01))` patients met this criteria.
- We censored at day 90.01 `r with(ptsummary_df, sum_na(elig_readm & ftype_readm_90 == "Censored" & tte_readm_90 == 90.01))` patient(s) who survived
the entire 90-day period after initial discharge, but remained hospitalized on
day 90.
- We assign patients who experience the competing risks of either hospital discharge (`r with(ptsummary_df, sum_na(elig_readm & ftype_readm_90 == "Discharge" & tte_readm_90 < 90.01 & !hospdis_noinfo))` patients) or death (`r with(ptsummary_df, sum_na(elig_readm & ftype_readm_90 == "Death" & tte_readm_90 < 90.01 & !hospdis_noinfo))` patients) prior to 90 days after first ICU
discharge a time to event of `time of discharge/death - time of randomization` and a "failure type" of hospital discharge and death, respectively.
- We assign the `r with(ptsummary_df, sum_na(elig_readm & ftype_readm_90 == "Readmission"))` patients who were readmitted to the ICU within 90 days of
first discharge a time value of `time of readmission - time of first ICU discharge` and a "failure type" of readmission.

### Unadjusted Analysis

We present cumulative incidence plots by treatment group for ICU readmission,
hospital discharge without readmission, and death, unadjusted for any
covariates. Please see the [Methods section](#unadjusted) for more details. All
`r  sum_na(ptsummary_df$elig_readm)` randomized patients who survived their
initial ICU admission and remained in the study are included.

`[insert general summary of results here]`

```{r cuminc_readm_unadj, warning = FALSE, fig.height = 6, fig.width = 8}
## Prep: Smaller df including only patients who survived first ICU stay
model_df_readm <- model_df %>% filter(elig_readm)

## -- Create Surv object -------------------------------------------------------
## Will be used for N at risk for CIF, as well as adjusted model fit
readm_90_Surv <- with(model_df_readm, {
  Surv(time = tte_readm_90, event = ftype_readm_90, type = "mstate")
})

## -- Create and summarize survfit object, create N at risk table --------------
readm_90_survfit <- survfit(readm_90_Surv ~ trt, data = model_df_readm)
readm_90_sfsum <- summary(readm_90_survfit, times = seq(0, 90, 15))

readm_90_risk_plot <- cr_risktable_plot(
  readm_90_sfsum,
  main_event = "Readmission",
  event_string = "ICU readmissions"
)

## -- Fit cumulative incidence functions by treatment --------------------------
readm_90_cif <- with(model_df_readm, {
  cuminc(
    ftime = tte_readm_90,
    fstatus = ftype_readm_90,
    group = trt,
    cencode = "Censored"
  )
})

## Create strings for test results
readm_90_tests_unadj <- cuminc_test(readm_90_cif)

## -- Plot CIFs, N at risk -----------------------------------------------------
## Create plot for competing risks
readm_90_cif_plot <- cif_plot(
  cuminc_obj = readm_90_cif,
  legend_string = "ICU Readmission",
  event_string = "ICU Readmission",
  test_string = readm_90_tests_unadj,
  caption_string = ''
)

## Print combined plot
cr_combine_plots(
  cif = readm_90_cif_plot,
  rt = readm_90_risk_plot,
  xmax = 91, time_breaks = c(0, seq(5, 90, 15)),
  caption_string = ''
)

```

### Adjusted Analysis

`[insert general summary of results here]`

#### Model Fitting and Assumptions {.tabset}

We use Fine & Gray's[^fg] method of competing risks regression to examine the
relationship between treatment and (primarily) ICU readmission. For further
details, please see the [Methods section](#adjusted). All `r with(model_df, sum_na(elig_readm & comp_covars))` randomized patients with complete covariate data who survived their first ICU stay and remained in the study are included.

##### Model Fitting

```{r readm_90_adj}
## -- Fit competing risks model using survival::finegray(), rms::cph() ---------

## -- Create dataset specifically for Fine-Gray method of competing risks ------
readm_90_fg <- finegray(
  ## Use **linear** RHS here; we'll fit spline terms within model formula itself
  as.formula(paste("readm_90_Surv ~", mod_rhs_lin)),
  data = model_df_readm,
  etype = "Readmission",
  id = id,
  count = "fgcount"
)

## -- Fit actual model, using variables/weights from finegray() ----------------
readm_90_mod <- cph(
  as.formula(paste("Surv(fgstart, fgstop, fgstatus) ~", mod_rhs)),
  data = readm_90_fg,
  weights = fgwt,
  x = TRUE, y = TRUE
)

```

##### Assumptions

```{r readm_90_assume}
## -- Check proportional hazard assumption -------------------------------------
readm_90_zph <- cox.zph(readm_90_mod, transform = 'log')

## Extract p-value for global PH assumption; create reproducible statement
readm_90_phtext <- text_ph_assume(readm_90_zph)

```

We graphically check our assumption of proportional hazards for the ICU
readmission subdistribution, paying particular attention to treatment group and
looking for generally flat lines in each panel. `r readm_90_phtext`

**NOTE:** THIS IS NOT WORKING, ALL NANs

```{r readm_90_assumeplot}
# plot_ph_assume(readm_90_zph)

```

#### Model Results {.tabset}

```{r readm_90_hrs_prep}
## -- Calculate hazard ratios for both treatments vs placebo -------------------
readm_90_hrs <- trt_ratios(readm_90_mod)

## Create explanatory text string for subdistribution HRs
readm_90_text <-
  hr_example(hr_df = readm_90_hrs, outcome = "ICU readmission")

```

We show the subdistribution hazard ratios for ICU readmission for haloperidol
and ziprasidone vs placebo. Subdistribution hazard ratios **lower** than 1 are
favorable for this outcome. `r readm_90_text[["Haloperidol"]]`

TREATMENTS ARE ONCE AGAIN COMPLETELY FAKE

##### Visual Form

```{r readm_90_hrs_plot, fig.width = 5, fig.height = 3.5}
readm_90_hrs_plot <- plot_trt_ratios(
  ratio_df = readm_90_hrs,
  outcome_text = "ICU Readmission",
  # extra_text = glue(
  #   "\n\n",
  #   '"Successful": liberation from MV during the intervention period, ',
  #   "followed by at least 48 hours alive without reinitiation.\n",
  #   "Patients who withdrew & revoked access to PHI ",
  #   "are censored on the day of withdrawal.\n",
  #   "Deaths prior to liberation are accounted for using competing risks."
  # ),
  mod = readm_90_mod
) +
  theme(plot.caption = element_text(size = basetext_size * 0.6),
        plot.title = element_text(size = basetext_size * 1.15))

readm_90_hrs_plot

```

##### Tabular Form

```{r table_readm_90_hrs}
table_trt_ratios(ratio_df = readm_90_hrs)

```

##### Results for All Covariates

Since most of the continuous covariates are modeled using restricted cubic
splines (see the [Methods section](#covariates) for more details), a single
subdistribution hazard ratio/CI is insufficient to describe the entire
relationship between each of these covariates and the relative incidence of
ICU readmission. Rather, each subdistribution hazard ratio reflects a
comparison between two specific values of the covariate, as noted in the table.

```{r readm_90_full_results, warning = FALSE}
rms_results_kable(readm_90_mod)

```

# Notes on Variable Calculation{#varcalc}

<hr>

## Severity of Illness{#soi}

Due to the nature of clinical data collection, we had some missing values for APACHE II and SOFA components despite our coordinators' best efforts. We handled these missing values in the following ways:

### APACHE II (ICU admission only)

- Oxygenation: If no arterial blood gas was done, we converted the lowest O2 saturation to PaO2 per the [EPIC II conversions](http://intensive.org/epic2/Documents/Estimation%20of%20PO2%20and%20FiO2.pdf) and assigned points based on PaO2 alone. O2 saturations below the lowest level included in the conversion table were assigned the lowest PaO2; O2 saturations of 100 were assigned the highest PaO2.
- pH: If no arterial blood gas was done, we used the serum HCO3 conversions noted in the original reference.
- Glasgow Coma Score: If no GCS was available, we assigned points for the APACHE using the lowest RASS on the day of ICU admission using [Vasilevskis et al's](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4748963/) point values for the SOFA.
- All other components: If no values were available on a given day, we looked for a value on the closest day within the three full days after ICU admission. If none was available, we assumed that no measurement implied no clinical reason to suspect dysfunction, and assigned a normal value (0 points).

### SOFA (ICU admission + daily throughout intervention period)

- Substitutions for specific components:
    - Respiratory: If P/F ratio was not available, we used the lowest S/F ratio, per [Pandharipande et al](https://www.ncbi.nlm.nih.gov/pubmed/19242333).
    - Central nervous system: If no GCS was available, we used the lowest RASS available that day, per [Vasilevskis et al](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4748963/), method C.
- Missing data at ICU admission:

    Using only data from ICU admission, there are `r sum(is.na(ptsummary_all_df$sofa_adm_only))` consented patients and  `r sum(is.na(ptsummary_df$sofa_adm_only))` randomized patients missing at least one SOFA component score. For these patients' missing components, we imputed the next available value within the following two calendar days. If none was available, we assumed a normal value (0 points). (This could happen either because there was no clinical reason to order labs, or because the patient was not consented within three days of ICU admission and thus no study data was collected in that period.)
    
- Missing data during the intervention period:
    - We were unable to calculate SOFA scores using raw data on `r sum(is.na(subset(daily_int_df, study_status == "Intervention")$sofa_raw))` patient-days during the study period (randomization + 13 days). *(Missingness is much higher after the official intervention/post-intervention periods, when patients were no longer being actively followed for daily data collection. However, in this analysis we are only concerned about the official 14-day study period.)*
    - If the data required to calculate a given component was unavailable, we imputed the closest non-missing component score before *or* after the missing day, up to two full days away (missing day +/-2 days). If data was available X days both before *and* after the missing day, we prioritized past over future values.
    - If, after this imputation, values are still missing, we assume that no available data indicates no clinical reason to suspect organ dysfunction and therefore impute a normal value for that component. Again, this applies to `r sum(is.na(subset(daily_int_df, study_status == "Intervention")$sofa_raw))` patient-days during the study period.
        
## Medications

- **Benzodiazepines** include midazolam, lorazepam, and/or diazepam. Doses are expressed in midazolam equivalents.
- **Opioids** include fentanyl, morphine, and/or hydromorphone. Doses are expressed in fentanyl equivalents.
- **Antipsychotics** include open-label haloperidol, open-label ziprasidone, quetiapine, aripiprazole, olanzapine (including in combination with fluoxetine), and/or risperidone. Doses are expressed in haloperidol equivalents.
- All conversion formulas can be found in [this spreadsheet](https://docs.google.com/spreadsheets/d/1ZGfxAmTFxGgfzjwE0trrpKEn_21QDwCSGJIv-E5kiE4/edit?usp=sharing).

## Mechanical Ventilation

During the course of the study, patients could be on invasive mechanical ventilation (invasive MV), noninvasive positive pressure support (NIPPV), both,
or neither. For our purposes, "time on MV" describes the number of days each patient was on *either* type of ventilation beginning at the time of
randomization, **including** time between discontinuation of MV and reinitiation
or death, if that time is less than 48 hours. (In other words, if a patient was extubated at 12pm and died at 3pm, those final three hours are included in the total time on MV.)

"Liberation from mechanical ventilation" indicates the first discontinuation of either type of MV which was followed by at least 48 hours alive without reinitiation of MV.

## Delirium/Coma-Free Days{#dcfds}

This primary outcome variable is calculated over the 14 days including and immediately following randomization. It is defined as days alive and without brain dysfunction.

### Determining Mental Status Using CAM and RASS

We determined mental status for a given *assessment* using the following criteria:

1. **Comatose**: RASS -4 or -5, **or** RASS missing and CAM Unable to Assess
1. **Delirious**: RASS missing or >= -3, and CAM Positive
1. **Normal**: RASS missing or >= -3, and CAM Negative

Patients could have multiple assessments on a given study day. On a given *day*, a patient was considered delirious if any assessment was considered delirious; comatose if no assessments met criteria for delirium and at least one was considered comatose; and normal if no assessments met criteria for delirium or coma, and at least one was considered normal.

<!-- ### Handling Missing Data -->

<!-- Among all consented patients, `r sum(is.na(daily_all_df$mental_status_raw))` (`r round(mean(is.na(daily_all_df$mental_status_raw)) * 100)`%) in-hospital patient-days have insufficient information to determine mental status (due to missing data or study withdrawal). -->

<!-- Among randomized patients during the intervention period, `r sum(is.na(subset(daily_int_df, study_status == "Intervention")$mental_status_raw))` (`r round(mean(is.na(subset(daily_int_df, study_status == "Intervention")$mental_status_raw)) * 100)`%) of patient-days have missing mental status, again due either to missing data or study withdrawal. -->

<!-- Mental status can change quickly; therefore simple imputation methods like last observation carried forward could be inaccurate. Since we are fortunate to have strong covariate data, we performed single imputation using polytomous logistic regression, including the following variables as covariates in the imputation. -->

<!-- - **Baseline**: Age at consent; gender; BMI; education; level of proficiency in English; insurance; home antipsychotic use; Charlson comorbidities index; CSHA Clinical Frailty Score; APACHE II APS -->
<!-- - **Daily**: -->
<!--     - Medications (clonazepam, dexmedetomidine, propofol, remifentanil, antipsychotics, benzodiazepines, opioids [IV and PO], antibiotics, anxiolytics, statins) -->
<!--     - Variables indicating severity of illness (CV SOFA, creatinine, urine output, platelets, lowest recorded RASS, Glasgow Coma Scale, P/F ratio, S/F ratio, bilirubin) -->
<!--     - Any mental status data available the day of, the day before, and the day after the missing day -->

<!-- All summary variables (delirium/coma-free days, delirium duration, and coma duration) are presented using imputed mental status. -->

# Software Details{#software}

---

`r devtools::session_info()$platform$version` was used for all analyses. `r table_nums('package_info', display = 'cite')` shows all add-on packages loaded.

<details>

#### `r table_nums('package_info')`

```{r technical, results = 'asis'}
devtools::session_info()$packages %>%
  kable(
    format = "html",
    col.names = c("Package", "*", "Version", "Date", "Source")
  ) %>%
  mykablestyle(stripes = TRUE)

```
</details>

<hr>
